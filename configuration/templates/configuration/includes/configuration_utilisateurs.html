{# templates/configuration/includes/configuration_utilisateurs.html #}
<div class="card">
  <div class="card-body">
    <h4 class="mb-3"><i class="fa fa-users-gear me-1"></i> Gestion des utilisateurs</h4>

    {# ======= MOBILE: bouton "Filtres" + panneau repliable ======= #}
    <div class="d-md-none mb-3">
      <button class="btn btn-outline-success w-100" type="button"
              data-bs-toggle="collapse" data-bs-target="#usersFiltersCollapse"
              aria-expanded="false" aria-controls="usersFiltersCollapse">
        <i class="fa fa-sliders-h me-1"></i> Filtres
      </button>

      <div id="usersFiltersCollapse" class="collapse mt-2">
        <form method="get" class="vstack gap-2">
          <input type="hidden" name="tab" value="utilisateurs">

          <input type="text" name="q" value="{{ q }}" class="form-control"
                 placeholder="Rechercher (nom, email, téléphone, adresse)">

          <select name="role" class="form-select">
            <option value="">— Tous rôles —</option>
            {% for r in roles %}
              <option value="{{ r.id }}" {% if role_id|default:''|stringformat:"s" == r.id|stringformat:"s" %}selected{% endif %}>
                {{ r.role }}
              </option>
            {% endfor %}
          </select>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="m_only_active" name="only_active" {% if only_active %}checked{% endif %}>
            <label for="m_only_active" class="form-check-label">Actifs</label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="m_only_waiting_validation" name="only_waiting_validation" {% if only_waiting_validation %}checked{% endif %}>
            <label for="m_only_waiting_validation" class="form-check-label">En attente validation</label>
          </div>

          <button class="btn btn-success w-100">
            <i class="fa fa-search"></i> Filtrer
          </button>
        </form>
      </div>
    </div>

    {# ======= DESKTOP: barre horizontale ======= #}
    <form class="row g-2 align-items-center mb-3 d-none d-md-flex" method="get">
      <input type="hidden" name="tab" value="utilisateurs">

      <div class="col-md-4">
        <input type="text" name="q" value="{{ q }}" class="form-control"
               placeholder="Rechercher (nom, email, téléphone, adresse)">
      </div>

      <div class="col-md-3">
        <select name="role" class="form-select">
          <option value="">— Tous rôles —</option>
          {% for r in roles %}
            <option value="{{ r.id }}" {% if role_id|default:''|stringformat:"s" == r.id|stringformat:"s" %}selected{% endif %}>
              {{ r.role }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="only_active" name="only_active" {% if only_active %}checked{% endif %}>
          <label for="only_active" class="form-check-label">Actifs uniquement</label>
        </div>
      </div>

      <div class="col-md-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="only_waiting_validation" name="only_waiting_validation" {% if only_waiting_validation %}checked{% endif %}>
          <label for="only_waiting_validation" class="form-check-label">En attente validation</label>
        </div>
      </div>

      <div class="col-md-auto">
        <button class="btn btn-success"><i class="fa fa-search"></i> Filtrer</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:72px">#</th>
            <th>Identité</th>
            <th>Email</th>
            <th style="width:220px">Rôle</th>
            <th style="width:110px">Actif</th>
            <th style="width:160px">Validé par admin</th>
            <th style="width:140px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in page_obj.object_list %}
            <tr id="user-row-{{ u.id }}">
              <td class="text-muted">{{ u.id }}</td>

              <td>
                <div class="fw-semibold">{{ u.username }}</div>
                <div class="small text-muted">
                  {{ u.first_name }} {{ u.last_name }}
                  {% if u.telephone %} • {{ u.telephone }}{% endif %}
                </div>
              </td>

              <td>
                {% if u.email %}
                  <a href="mailto:{{ u.email }}">{{ u.email }}</a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              {# --- mini form par ligne, référencé par form="" --- #}
              <form id="f{{ u.id }}"
                    method="post"
                    action="{% url 'config_user_update' u.id %}"
                    hx-post="{% url 'config_user_update' u.id %}"
                    hx-swap="none"
                    hx-indicator="#hxIndicator"
                    class="d-none">
                {% csrf_token %}
              </form>

              {# Rôle #}
              <td>
                <select name="role_id" form="f{{ u.id }}" class="form-select form-select-sm">
                  <option value="">— Aucun —</option>
                  {% for r in roles %}
                    <option value="{{ r.id }}" {% if u.role_id == r.id %}selected{% endif %}>{{ r.role }}</option>
                  {% endfor %}
                </select>
              </td>

              {# Actif #}
              <td class="text-center">
                <input type="hidden" name="is_active" value="0" form="f{{ u.id }}">
                <input class="form-check-input" type="checkbox"
                       aria-label="Actif"
                       name="is_active" value="1" form="f{{ u.id }}"
                       {% if u.is_active %}checked{% endif %}>
              </td>

              {# Validé par admin #}
              <td class="text-center">
                <input type="hidden" name="is_validated_by_admin" value="0" form="f{{ u.id }}">
                <input class="form-check-input" type="checkbox"
                       aria-label="Validé par admin"
                       name="is_validated_by_admin" value="1" form="f{{ u.id }}"
                       {% if u.is_validated_by_admin %}checked{% endif %}>
              </td>

              {# Actions : Mise à jour + Ouvrir modal suppression #}
              <td class="text-end">
                <button type="submit" form="f{{ u.id }}" class="btn btn-success btn-sm" title="Mettre à jour">
                  <i class="fa fa-save"></i>
                </button>

                <button class="btn btn-outline-danger btn-sm ms-1"
                        title="Supprimer"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteUserModal"
                        data-user-id="{{ u.id }}"
                        data-username="{{ u.username }}"
                        data-delete-url="{% url 'config_user_delete' u.id %}"
                        data-row-selector="#user-row-{{ u.id }}"
                        {% if u.id == request.user.id or u.is_superuser %}disabled{% endif %}>
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="text-center text-muted py-4">Aucun utilisateur trouvé.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav>
        <ul class="pagination pagination-sm">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page=1{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&laquo;</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&lsaquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
          {% endif %}

          <li class="page-item disabled"><span class="page-link">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&rsaquo;</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>

{# ===================== MODAL DE CONFIRMATION SUPPRESSION ===================== #}
<div class="modal fade" id="confirmDeleteUserModal" tabindex="-1" aria-labelledby="confirmDeleteUserLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteUserLabel"><i class="fa fa-triangle-exclamation me-1"></i> Confirmer la suppression</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          Voulez-vous vraiment supprimer l’utilisateur
          <span class="fw-bold" id="confirmDeleteUserName">—</span> ?
          <br><small class="text-muted">Cette action est irréversible.</small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>

        {# Formulaire HTMX déclenché depuis le modal #}
        <form id="confirmDeleteUserForm"
              method="post"
              action="#"
              hx-post="#"
              hx-target=""
              hx-swap="delete"
              hx-indicator="#hxIndicator">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="fa fa-trash"></i> Supprimer
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{# Indicateur (utilisé par hx-indicator) #}
<div id="hxIndicator" class="position-fixed bottom-0 end-0 m-3 d-none">
  <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
</div>

{# Toast feedback #}
<div id="hxToast" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="z-index:1080; display:none;">
  <div class="d-flex">
    <div class="toast-body" id="hxToastBody">Utilisateur mis à jour</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"
            onclick="document.getElementById('hxToast').style.display='none'"></button>
  </div>
</div>

<script>
  // Spinner HTMX
  document.body.addEventListener('htmx:configRequest', function () {
    document.getElementById('hxIndicator')?.classList.remove('d-none');
  });
  document.body.addEventListener('htmx:afterRequest', function () {
    document.getElementById('hxIndicator')?.classList.add('d-none');
  });

  // Toast via HX-Trigger
  document.body.addEventListener('htmx:afterOnLoad', function(e){
    const trig = e.detail.xhr?.getResponseHeader?.('HX-Trigger');
    if (!trig) return;
    try {
      const data = JSON.parse(trig);
      if (data.flash?.message) {
        const toast = document.getElementById('hxToast');
        const body  = document.getElementById('hxToastBody');
        if (body) body.textContent = data.flash.message;
        if (toast) {
          toast.classList.remove('text-bg-success','text-bg-danger','text-bg-warning');
          const t = (data.flash.type || 'success').toLowerCase();
          toast.classList.add(t === 'danger' ? 'text-bg-danger' : t === 'warning' ? 'text-bg-warning' : 'text-bg-success');
          toast.style.display = 'block';
          setTimeout(()=>{ toast.style.display='none'; }, 1800);
        }
      }
    } catch {}
  });

  // Bootstrap modal: injecter dynamiquement l'URL et la cible HTMX
  const deleteModal = document.getElementById('confirmDeleteUserModal');
  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    if (!button) return;

    const username   = button.getAttribute('data-username') || '—';
    const deleteUrl  = button.getAttribute('data-delete-url') || '#';
    const rowSelector= button.getAttribute('data-row-selector') || '';

    // Texte du modal
    const nameSpan = deleteModal.querySelector('#confirmDeleteUserName');
    if (nameSpan) nameSpan.textContent = `« ${username} »`;

    // Câbler le formulaire HTMX
    const form = deleteModal.querySelector('#confirmDeleteUserForm');
    if (form) {
      form.setAttribute('action', deleteUrl);
      form.setAttribute('hx-post', deleteUrl);
      if (rowSelector) {
        form.setAttribute('hx-target', rowSelector);
      } else {
        form.removeAttribute('hx-target');
      }
    }
  });

  // Après suppression, fermer le modal si toujours ouvert
  document.body.addEventListener('htmx:afterOnLoad', function(){
    const modalEl = document.getElementById('confirmDeleteUserModal');
    if (!modalEl) return;
    const instance = bootstrap.Modal.getInstance(modalEl);
    if (instance) { instance.hide(); }
  });
</script>
