{# templates/configuration/includes/configuration_utilisateurs.html #}
<div class="card">
  <div class="card-body">
    <h4 class="mb-3"><i class="fa fa-users-gear me-1"></i> Gestion des utilisateurs</h4>

    <form class="row g-2 mb-3" method="get">
      <input type="hidden" name="tab" value="utilisateurs">
      <div class="col-md-4">
        <input type="text" name="q" value="{{ q }}" class="form-control"
               placeholder="Rechercher (nom, email, téléphone, adresse)">
      </div>
      <div class="col-md-3">
        <select name="role" class="form-select">
          <option value="">— Tous rôles —</option>
          {% for r in roles %}
            <option value="{{ r.id }}" {% if role_id|default:''|stringformat:"s" == r.id|stringformat:"s" %}selected{% endif %}>
              {{ r.role }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 form-check d-flex align-items-center">
        <input class="form-check-input me-2" type="checkbox" id="only_active" name="only_active" {% if only_active %}checked{% endif %}>
        <label for="only_active" class="form-check-label">Actifs uniquement</label>
      </div>
      <div class="col-md-3 form-check d-flex align-items-center">
        <input class="form-check-input me-2" type="checkbox" id="only_waiting_validation" name="only_waiting_validation" {% if only_waiting_validation %}checked{% endif %}>
        <label for="only_waiting_validation" class="form-check-label">En attente validation</label>
      </div>
      <div class="col-12 col-md-auto">
        <button class="btn btn-success"><i class="fa fa-search"></i> Filtrer</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Identité</th>
            <th>Email</th>
            <th>Rôle</th>
            <th class="text-center">Actif</th>
            <th class="text-center">Validé admin</th>
          </tr>
        </thead>
        <tbody>
          {% for u in page_obj.object_list %}
            <tr>
              <td class="text-muted">{{ u.id }}</td>
              <td>
                <div class="fw-semibold">{{ u.username }}</div>
                <div class="small text-muted">
                  {{ u.first_name }} {{ u.last_name }}
                  {% if u.telephone %} • {{ u.telephone }}{% endif %}
                </div>
              </td>
              <td>
                {% if u.email %}
                  <a href="mailto:{{ u.email }}">{{ u.email }}</a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td style="min-width: 220px;">
                <form method="post"
                      hx-post="{% url 'config_user_update' u.id %}"
                      hx-trigger="change"
                      hx-swap="none"
                      class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="field" value="role_id">
                  <select name="role_id" class="form-select form-select-sm">
                    <option value="">— Aucun —</option>
                    {% for r in roles %}
                      <option value="{{ r.id }}" {% if u.role_id == r.id %}selected{% endif %}>{{ r.role }}</option>
                    {% endfor %}
                  </select>
                </form>
              </td>
              <td class="text-center">
                <form method="post"
                      hx-post="{% url 'config_user_update' u.id %}"
                      hx-trigger="change"
                      hx-swap="none"
                      class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="field" value="is_active">
                  <div class="form-check d-inline-flex">
                    <input class="form-check-input" type="checkbox" name="is_active" {% if u.is_active %}checked{% endif %}>
                  </div>
                </form>
              </td>
              <td class="text-center">
                <form method="post"
                      hx-post="{% url 'config_user_update' u.id %}"
                      hx-trigger="change"
                      hx-swap="none"
                      class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="field" value="is_validated_by_admin">
                  <div class="form-check d-inline-flex">
                    <input class="form-check-input" type="checkbox" name="is_validated_by_admin" {% if u.is_validated_by_admin %}checked{% endif %}>
                  </div>
                  {% if not u.is_validated_by_admin %}
                    <div class="small text-muted">Valider active aussi le compte</div>
                  {% endif %}
                </form>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-center text-muted py-4">Aucun utilisateur trouvé.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav>
        <ul class="pagination pagination-sm">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page=1{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&laquo;</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&lsaquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
          {% endif %}

          <li class="page-item disabled"><span class="page-link">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&rsaquo;</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>
