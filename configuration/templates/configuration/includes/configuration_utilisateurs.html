{# templates/configuration/includes/configuration_utilisateurs.html #}
{% load static %}

<style>
  @media (max-width: 767.98px){
    .card.shadow-sm{ box-shadow: 0 .25rem .5rem rgba(0,0,0,.075)!important; }
  }

  /* Egalisation des hauteurs (sans figer la largeur de la colonne) */
  .user-col{ display:flex; }
  .user-card{
    display:flex;
    flex-direction:column;
    height:100%;
    width:100%;
    min-width:0;       /* autorise les truncates à fonctionner */
    min-height:230px;  /* xs */
    overflow:hidden;   /* évite tout débordement visuel */
  }
  .user-card .card-body{ flex:1 1 auto; }
  .user-card .card-footer{ flex-shrink:0; }

  @media (min-width:576px){ .user-card{ min-height:240px; } } /* sm */
  @media (min-width:768px){ .user-card{ min-height:260px; } } /* md */
  @media (min-width:992px){ .user-card{ min-height:260px; } } /* lg */

  /* Avatars */
  .avatar-56{ width:56px; height:56px; border-radius:50%; object-fit:cover; }
  .avatar-40{ width:40px; height:40px; border-radius:50%; object-fit:cover; }

  /* Header d'identité de la carte */
  .card-identity{
    display:flex;
    align-items:center;
    gap:.5rem;
    flex-wrap:wrap;    /* ⟵ permet d'aller à la ligne si trop serré */
  }
  .card-identity .info{
    min-width:0;       /* ⟵ requis pour que text-truncate marche en flex */
  }

  /* Casser proprement les emails/numéros/longs mots */
  .break-anywhere{
    overflow-wrap:anywhere;
    word-break:break-word;
  }
</style>

<div class="card">
  <div class="card-body">
    <h4 class="mb-3"><i class="fa fa-users-gear me-1"></i> Gestion des utilisateurs</h4>

    {# ======= MOBILE/TABLET/LAPTOP (< xl) : bouton "Filtres" ======= #}
    <div class="d-xl-none mb-3">
      <button class="btn btn-outline-success w-100" type="button"
              data-bs-toggle="collapse" data-bs-target="#usersFiltersCollapse"
              aria-expanded="false" aria-controls="usersFiltersCollapse">
        <i class="fa fa-sliders-h me-1"></i> Filtres
      </button>

      <div id="usersFiltersCollapse" class="collapse mt-2">
        <form method="get" class="vstack gap-2">
          <input type="hidden" name="tab" value="utilisateurs">

          <input type="text" name="q" value="{{ q }}" class="form-control"
                 placeholder="Rechercher (nom, email, téléphone, adresse)">

          <select name="role" class="form-select">
            <option value="">— Tous rôles —</option>
            {% for r in roles %}
              <option value="{{ r.id }}" {% if role_id|default:''|stringformat:"s" == r.id|stringformat:"s" %}selected{% endif %}>{{ r.role }}</option>
            {% endfor %}
          </select>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="m_only_active" name="only_active" {% if only_active %}checked{% endif %}>
            <label for="m_only_active" class="form-check-label">Actifs</label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="m_only_waiting_validation" name="only_waiting_validation" {% if only_waiting_validation %}checked{% endif %}>
            <label for="m_only_waiting_validation" class="form-check-label">En attente validation</label>
          </div>

          <button class="btn btn-success w-100"><i class="fa fa-search"></i> Filtrer</button>
        </form>
      </div>
    </div>

    {# ======= DESKTOP LARGE (≥ xl) : barre horizontale ======= #}
    <form class="row g-2 align-items-center mb-3 d-none d-xl-flex" method="get">
      <input type="hidden" name="tab" value="utilisateurs">

      <div class="col-xl-4">
        <input type="text" name="q" value="{{ q }}" class="form-control"
               placeholder="Rechercher (nom, email, téléphone, adresse)">
      </div>

      <div class="col-xl-3">
        <select name="role" class="form-select">
          <option value="">— Tous rôles —</option>
          {% for r in roles %}
            <option value="{{ r.id }}" {% if role_id|default:''|stringformat:"s" == r.id|stringformat:"s" %}selected{% endif %}>{{ r.role }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-xl-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="only_active" name="only_active" {% if only_active %}checked{% endif %}>
          <label for="only_active" class="form-check-label">Actifs uniquement</label>
        </div>
      </div>

      <div class="col-xl-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="only_waiting_validation" name="only_waiting_validation" {% if only_waiting_validation %}checked{% endif %}>
          <label for="only_waiting_validation" class="form-check-label">En attente validation</label>
        </div>
      </div>

      <div class="col-xl-auto">
        <button class="btn btn-success"><i class="fa fa-search"></i> Filtrer</button>
      </div>
    </form>

    {# ======= LISTE UTILISATEURS ======= #}

    {# --- Vue TABLE (≥ xl) --- #}
    <div class="table-responsive d-none d-xl-block">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:64px">Photo</th>
            <th>Identité</th>
            <th>Email</th>
            <th style="width:220px">Rôle</th>
            <th style="width:110px" class="text-center">Actif</th>
            <th style="width:160px" class="text-center">Validé par admin</th>
            <th style="width:140px" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in page_obj.object_list %}
            {% include "configuration/includes/_user_row.html" with u=u roles=roles %}
          {% empty %}
            <tr><td colspan="7" class="text-center text-muted py-4">Aucun utilisateur trouvé.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# --- Vue CARTES (< xl) --- #}
    <div class="d-xl-none">
      <div class="row g-2 row-cols-1 row-cols-sm-2 row-cols-md-3">
        {% for u in page_obj.object_list %}
          <div class="col user-col" id="user-card-col-{{ u.id }}">
            <div class="card shadow-sm mb-2 h-100 user-card w-100" id="user-card-{{ u.id }}">
              <div class="card-body py-2">

                {# En-tête avatar + identité (wrap si manque d'espace) #}
                <div class="card-identity">
                  {% if u.profil_photo %}
                    <img src="{{ u.profil_photo.url }}" alt="{{ u.username }}" class="avatar-56">
                  {% else %}
                    <img src="{% static 'images/default.jpg' %}" alt="—" class="avatar-56">
                  {% endif %}

                  <div class="info">
                    <div class="small text-muted">#{{ u.id }}</div>
                    <div class="fw-semibold text-truncate">{{ u.username }}</div>
                    <div class="small text-muted break-anywhere">
                      {{ u.first_name }} {{ u.last_name }}{% if u.telephone %} • {{ u.telephone }}{% endif %}
                    </div>
                  </div>
                </div>

                <div class="small mt-2 break-anywhere">
                  {% if u.email %}
                    <a class="break-anywhere" href="mailto:{{ u.email }}">{{ u.email }}</a>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>

                <div class="mt-2">
                  <label class="form-label mb-1 small text-muted">Rôle</label>
                  <select name="role_id" form="fc{{ u.id }}" class="form-select form-select-sm">
                    <option value="">— Aucun —</option>
                    {% for r in roles %}
                      <option value="{{ r.id }}" {% if u.role_id == r.id %}selected{% endif %}>{{ r.role }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="d-flex gap-3 mt-2">
                  <div class="form-check">
                    <input type="hidden" name="is_active" value="0" form="fc{{ u.id }}">
                    <input class="form-check-input" type="checkbox" id="m_is_active_{{ u.id }}"
                           name="is_active" value="1" form="fc{{ u.id }}" {% if u.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="m_is_active_{{ u.id }}">Actif</label>
                  </div>

                  <div class="form-check">
                    <input type="hidden" name="is_validated_by_admin" value="0" form="fc{{ u.id }}">
                    <input class="form-check-input" type="checkbox" id="m_is_validated_{{ u.id }}"
                           name="is_validated_by_admin" value="1" form="fc{{ u.id }}"
                           {% if u.is_validated_by_admin %}checked{% endif %}>
                    <label class="form-check-label" for="m_is_validated_{{ u.id }}">Validé par admin</label>
                  </div>
                </div>
              </div>

              <div class="card-footer d-flex justify-content-end gap-2 py-2">
                <form id="fc{{ u.id }}"
                      method="post"
                      action="{% url 'config_user_update' u.id %}"
                      hx-post="{% url 'config_user_update' u.id %}"
                      hx-target="#user-card-{{ u.id }}"
                      hx-swap="outerHTML"
                      hx-indicator="#hxIndicator"
                      hx-include="#user-card-{{ u.id }} input, #user-card-{{ u.id }} select"
                      class="d-none">
                  {% csrf_token %}
                </form>

                <button type="submit" form="fc{{ u.id }}" class="btn btn-success btn-sm" title="Mettre à jour">
                  <i class="fa fa-save"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm"
                        title="Supprimer"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteUserModal"
                        data-user-id="{{ u.id }}"
                        data-username="{{ u.username }}"
                        data-delete-url="{% url 'config_user_delete' u.id %}"
                        data-row-selector="#user-card-col-{{ u.id }}"
                        {% if u.id == request.user.id or u.is_superuser %}disabled{% endif %}>
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-4">Aucun utilisateur trouvé.</div>
        {% endfor %}
      </div>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav class="mt-2">
        <ul class="pagination pagination-sm justify-content-center justify-content-xl-start">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page=1{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&laquo;</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&lsaquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
          {% endif %}

          <li class="page-item disabled"><span class="page-link">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&rsaquo;</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?tab=utilisateurs&page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}{% if role_id %}&role={{ role_id }}{% endif %}{% if only_active %}&only_active=on{% endif %}{% if only_waiting_validation %}&only_waiting_validation=on{% endif %}">&raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>

{# ===================== MODAL DE CONFIRMATION SUPPRESSION ===================== #}
<div class="modal fade" id="confirmDeleteUserModal" tabindex="-1" aria-labelledby="confirmDeleteUserLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteUserLabel"><i class="fa fa-triangle-exclamation me-1"></i> Confirmer la suppression</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          Voulez-vous vraiment supprimer l’utilisateur
          <span class="fw-bold" id="confirmDeleteUserName">—</span> ?
          <br><small class="text-muted">Cette action est irréversible.</small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>

        {# Formulaire HTMX déclenché depuis le modal #}
        <form id="confirmDeleteUserForm"
              method="post"
              action="#"
              hx-post="#"
              hx-target=""
              hx-swap="delete"
              hx-indicator="#hxIndicator">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="fa fa-trash"></i> Supprimer
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{# Indicateur HTMX #}
<div id="hxIndicator" class="position-fixed bottom-0 end-0 m-3 d-none">
  <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
</div>

{# Toast feedback #}
<div id="hxToast" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="z-index:1080; display:none;">
  <div class="d-flex">
    <div class="toast-body" id="hxToastBody">Utilisateur mis à jour</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"
            onclick="document.getElementById('hxToast').style.display='none'"></button>
  </div>
</div>

<script>
  // Spinner HTMX
  document.body.addEventListener('htmx:configRequest', function () {
    document.getElementById('hxIndicator')?.classList.remove('d-none');
  });
  document.body.addEventListener('htmx:afterRequest', function () {
    document.getElementById('hxIndicator')?.classList.add('d-none');
  });

  // Toast via HX-Trigger
  document.body.addEventListener('htmx:afterOnLoad', function(e){
    const trig = e.detail.xhr?.getResponseHeader?.('HX-Trigger');
    if (!trig) return;
    try {
      const data = JSON.parse(trig);
      if (data.flash?.message) {
        const toast = document.getElementById('hxToast');
        const body  = document.getElementById('hxToastBody');
        if (body) body.textContent = data.flash.message;
        if (toast) {
          toast.classList.remove('text-bg-success','text-bg-danger','text-bg-warning');
          const t = (data.flash.type || 'success').toLowerCase();
          toast.classList.add(t === 'danger' ? 'text-bg-danger' : t === 'warning' ? 'text-bg-warning' : 'text-bg-success');
          toast.style.display = 'block';
          setTimeout(()=>{ toast.style.display='none'; }, 1800);
        }
      }
    } catch {}
  });

  // Bootstrap modal: injecter dynamiquement l'URL et la cible HTMX
  const deleteModal = document.getElementById('confirmDeleteUserModal');
  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    if (!button) return;

    const username   = button.getAttribute('data-username') || '—';
    const deleteUrl  = button.getAttribute('data-delete-url') || '#';
    const rowSelector= button.getAttribute('data-row-selector') || '';

    const nameSpan = deleteModal.querySelector('#confirmDeleteUserName');
    if (nameSpan) nameSpan.textContent = `« ${username} »`;

    const form = deleteModal.querySelector('#confirmDeleteUserForm');
    if (form) {
      form.setAttribute('action', deleteUrl);
      form.setAttribute('hx-post', deleteUrl);
      if (rowSelector) { form.setAttribute('hx-target', rowSelector); }
      else { form.removeAttribute('hx-target'); }
    }
  });

  // Après suppression, fermer le modal si toujours ouvert
  document.body.addEventListener('htmx:afterOnLoad', function(){
    const modalEl = document.getElementById('confirmDeleteUserModal');
    if (!modalEl) return;
    const instance = bootstrap.Modal.getInstance(modalEl);
    if (instance) { instance.hide(); }
  });
</script>
