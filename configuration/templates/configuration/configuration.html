{% extends "base.html" %}
{% load static %}
{% load nombre %}

{% block title %}Configuration{% endblock %}

{% block content %}
<div class="container-fluid mb-3">
  <div class="row g-3">
    {# --- Sidebar (collapsible on md & down, sticky column on lg+) --- #}
    <div class="col-12 col-lg-4 col-xl-3">
      <!-- Toggle visible seulement en < lg -->
      <button class="btn btn-outline-success w-100 d-lg-none mb-2"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#configSidebarCollapse"
              aria-expanded="false"
              aria-controls="configSidebarCollapse">
        <i class="fa fa-sliders-h me-1"></i> Menu configuration
      </button>

      <nav id="configSidebar" class="position-lg-sticky" style="top: 80px;">
        <div id="configSidebarCollapse" class="collapse d-lg-block">
          <div id="configSidebarLinks" class="list-group">
            <a href="{% url 'configuration' %}?tab=pages"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'pages' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'pages' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-store"></i> Page | Boutique
            </a>

            <a href="{% url 'configuration' %}?tab=caisses"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'caisses' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'caisses' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-cash-register"></i> Caisses
            </a>

            <a href="{% url 'configuration' %}?tab=plans"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'plans' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'plans' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-list-ol"></i> Plan des comptes
            </a>

            <a href="{% url 'configuration' %}?tab=articles"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'articles' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'articles' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-boxes-stacked"></i> Gestion d'Articles
            </a>

            <a href="{% url 'configuration' %}?tab=livreurs"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'livreurs' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'livreurs' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-bicycle"></i> Livreurs
            </a>

            <a href="{% url 'configuration' %}?tab=frais"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'frais' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'frais' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-map-marker-alt"></i> Lieux et frais
            </a>

            <a href="{% url 'configuration' %}?tab=profil"
               class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'profil' %}active{% endif %}"
               hx-get="{% url 'configuration_section' 'profil' %}"
               hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
              <i class="fa fa-user-cog"></i> Profil
            </a>

            {# ðŸ‘‡ N'afficher ces entrÃ©es que pour les admins (superuser ou rÃ´le = admin/administrateur/superadmin) #}
            {% if can_manage_admin_things %}
              <a href="{% url 'configuration' %}?tab=utilisateurs"
                 class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'utilisateurs' %}active{% endif %}"
                 hx-get="{% url 'configuration_section' 'utilisateurs' %}"
                 hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
                <i class="fa fa-users-gear"></i> Utilisateurs
              </a>

              <a href="{% url 'configuration' %}?tab=roles"
                 class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if selected_section == 'roles' %}active{% endif %}"
                 hx-get="{% url 'configuration_section' 'roles' %}"
                 hx-target="#configContent" hx-swap="innerHTML" hx-push-url="true">
                <i class="fa fa-user-shield"></i> RÃ´les
              </a>
            {% endif %}
          </div>
        </div>
      </nav>
    </div>

    <!-- Contenu -->
    <div class="col-12 col-lg-8 col-xl-9">
      {% include "includes/messages_alert.html" %}

      <div id="configContent">
        {# Injection serveur de la section initiale uniquement #}
        {% include partial_template %}
      </div>
    </div>
  </div>
</div>

<script>
  // Gestion classe active cÃ´tÃ© client quand HTMX charge une autre section
  document.body.addEventListener('htmx:afterOnLoad', function (e) {
    try {
      const path = e.detail.pathInfo.requestPath || window.location.pathname;
      const paramsObj = e.detail.pathInfo.requestParameters || {};
      const params = new URLSearchParams(paramsObj);
      const url = new URL(path + (params.toString() ? ('?' + params.toString()) : ''), window.location.origin);
      const tab = url.searchParams.get('tab') || (url.pathname.split('/').pop()); // fallback

      document.querySelectorAll('#configSidebar a').forEach(a => a.classList.remove('active'));
      const activeLink =
        document.querySelector(`#configSidebar a[href$="tab=${tab}"]`) ||
        document.querySelector(`#configSidebar a[href$="/${tab}"]`);
      if (activeLink) activeLink.classList.add('active');
    } catch (err) { /* no-op */ }
  });
</script>
{% endblock %}
