{% extends "base.html" %}

{% block title %}Modifier la commande{% endblock %}

{% block content %}
<div class="container mb-2 mt-4">
  <h2 class="mb-4">Modifier la commande <span class="text-secondary">({{ commande.numero_facture }})</span></h2>

  {% include "includes/messages_alert.html" %}

  <form method="post">
    {% csrf_token %}

    <!-- Informations client -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">Informations sur le client</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="nom" class="form-label">Nom *</label>
            <input type="text" class="form-control" name="nom" id="nom" value="{{ commande.client.nom }}" required>
          </div>
          <div class="col-md-6">
            <label for="contact" class="form-label">Contact *</label>
            <input type="text" class="form-control" name="contact" id="contact" value="{{ commande.client.contact }}" required>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="lieu" class="form-label">Lieu *</label>
            <select name="lieu" id="lieu" class="form-control" required>
              <option value="" disabled>Choisir un lieu</option>
              {% for l in lieux %}
                <option value="{{ l.id }}" data-frais_livraison="{{ l.frais_livraison }}" data-frais_livreur="{{ l.frais_livreur }}"
                  {% if commande.client.lieu.id == l.id %}selected{% endif %}>
                  {{ l.lieu }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="precision_lieu" class="form-label">Pr√©cision lieu</label>
            <input type="text" class="form-control" name="precision_lieu" id="precision_lieu" value="{{ commande.client.precision_lieu }}">
          </div>
        </div>
      </div>
    </div>

    <!-- Informations sur la livraison -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white ">Informations sur la livraison</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="date_livraison" class="form-label">Date de livraison</label>
            <input type="date" class="form-control" name="date_livraison" id="date_livraison"
                   value="{{ commande.date_livraison|date:'Y-m-d' }}">
          </div>
          <div class="col-md-6">
            <label for="remarque" class="form-label">Remarque</label>
            <input type="text" class="form-control" name="remarque" id="remarque"
                   value="{{ commande.remarque|default_if_none:'' }}">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="frais_livraison" class="form-label">Frais de livraison</label>
            <input type="text" class="form-control" name="frais_livraison" id="frais_livraison"
                   value="{{ commande.frais_livraison }}">
          </div>
          <div class="col-md-6">
            <label for="frais_livreur" class="form-label">Frais livreur</label>
            <input type="text" class="form-control" name="frais_livreur" id="frais_livreur"
                   value="{{ commande.frais_livreur }}">
          </div>
        </div>
      </div>
    </div>

    <!-- Lignes de commande -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        Informations sur la commande
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label for="date_commande" class="form-label">Date de commande</label>
            <input type="date" class="form-control" name="date_commande" id="date_commande"
                   value="{{ commande.date_commande|date:'Y-m-d' }}">
          </div>
          <div class="col-md-4 mb-4">
            <label for="page" class="form-label">Page</label>
            <select name="page" id="page" class="form-select" required>
              <option value="">-- Choisir une page --</option>
              {% for p in pages %}
                <option value="{{ p.id }}" {% if commande.page.id == p.id %}selected{% endif %}>
                  {{ p.nom }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div id="lignesCommande">
          {% for ligne in lignes %}
          <div class="row mb-3">
            <div class="col-lg-3">
              <label class="form-label">Article</label>
              <select name="article" class="form-select" required onchange="mettreAJourPrix(this)">
                <option value="">-- Choisir --</option>
                {% for article in articles %}
                <option value="{{ article.id }}" data-prix="{{ article.prix_vente }}" data-stock="{{ article.stock }}" data-livraison="{{ article.livraison }}"
                        {% if article.id == ligne.article.id %}selected{% endif %}>
                  {{ article.nom }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-2">
              <label class="form-label">P.U</label>
              <input type="number" name="pu" class="form-control" step="100" value="{{ ligne.prix_unitaire }}" onchange="calculerTotal(this)">
            </div>
            <div class="col-lg-1">
              <label class="form-label">Qt√©</label>
              <input type="number" name="quantite" class="form-control" min="1" value="{{ ligne.quantite }}" onchange="calculerTotal(this)">
            </div>
            <div class="col-lg-1">
              <label class="form-label">Stock</label>
              <div data-stock="{{ ligne.stock }}" class="form-control-plaintext fw-bold text-center {% if ligne.stock > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ ligne.stock }}
              </div>
            </div>
            <div class="col-lg-2">
              <label class="form-label">Livraison</label>
              <input type="text" name="livraison" class="form-control" value="{{ ligne.article.livraison }}" readonly>
            </div>
            <div class="col-lg-2">
              <label class="form-label">Montant</label>
              <input type="number" name="montant" class="form-control" value="{{ ligne.montant }}" readonly>
            </div>
            <div class="col-lg-1 mt-md-1 d-flex align-items-end">
              <button type="button" class="btn btn-danger btn-sm" onclick="supprimerLigne(this)">‚úñ</button>
            </div>
          </div>
          {% endfor %}
        </div>

        <button type="button" class="btn btn-sm btn-outline-primary" onclick="ajouterLigne()">+ Ajouter un article</button>
      </div>

      <hr>
      <!-- Tableau r√©capitulatif total √† payer -->
      <div class="row mb-3">
        <div class="col-md-4 offset-md-8">
          <table class="table table-bordered">
            <tbody>
              <tr>
                <th>Total des articles</th>
                <td class="text-end"><span id="total_articles">0</span> Ar</td>
              </tr>
              <tr>
                <th>Frais de livraison</th>
                <td class="text-end"><span id="total_frais_livraison">0</span> Ar</td>
              </tr>
              <tr>
                <th>Total √† payer</th>
                <td class="fw-bold text-end"><span id="total_a_payer">0</span> Ar</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Boutons actions -->
    <div class="text-center">
      <a href="{% url 'liste_commandes' %}" class="btn btn-outline-primary">‚Üê Retour √† la liste</a>
      <button type="submit" class="btn btn-primary">Mettre √† jour</button>
    </div>

  </form>
</div>

<script>
  let articles = {{ articles_json|safe }};
  // üîí Par d√©faut on respecte le frais_livraison existant au chargement
  let fraisFromArticlesEnabled = false;

  function ajouterLigne() {
    const container = document.getElementById("lignesCommande");
    const div = document.createElement("div");
    div.classList.add("row", "mb-3");
    div.innerHTML = `
      <div class="col-lg-3">
        <label class="form-label">Article</label>
        <select name="article" class="form-select" required onchange="mettreAJourPrix(this)">
          <option value="">-- Choisir --</option>
          ${articles.map(a => `
            <option value="${a.id}" data-prix="${a.prix_vente}" data-stock="${a.stock}" data-livraison="${a.livraison}">
              ${a.nom}
            </option>`).join('')}
        </select>
      </div>
      <div class="col-lg-2">
        <label class="form-label">P.U</label>
        <input type="number" name="pu" class="form-control" step="100">
      </div>
      <div class="col-lg-1">
        <label class="form-label">Qt√©</label>
        <input type="number" name="quantite" class="form-control" min="1" value="1" onchange="calculerTotal(this)">
      </div>
      <div class="col-lg-1">
        <label class="form-label">Stock</label>
        <div data-name="stock_display" class="form-control-plaintext fw-bold text-center">-</div>
      </div>
      <div class="col-lg-2">
        <label class="form-label">Livraison</label>
        <input type="text" name="livraison" class="form-control" readonly>
      </div>
      <div class="col-lg-2">
        <label class="form-label">Montant</label>
        <input type="number" name="montant" class="form-control" readonly>
      </div>
      <div class="col-lg-1 mt-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.row').remove(); verifierLivraisonGratuite(); mettreAJourTotaux();">‚úñ</button>
      </div>
    `;
    container.appendChild(div);

    mettreAJourTotaux();
  }

  function supprimerLigne(button) {
    const row = button.closest('.row');
    if (row) {
      row.remove();
      verifierLivraisonGratuite();
      mettreAJourTotaux();
    }
  }

  // isInit: true quand on initialise l'affichage au chargement (ne pas toucher aux frais)
  function mettreAJourPrix(select, { isInit = false } = {}) {
    const option = select.selectedOptions[0];
    const pu = option.getAttribute("data-prix");
    const stock = option.getAttribute("data-stock");
    const livraison = option.getAttribute("data-livraison");
    const row = select.closest(".row");

    const puInput = row.querySelector('input[name="pu"]');
    if (puInput) puInput.value = pu;

    const livraisonInput = row.querySelector('input[name="livraison"]');
    if (livraisonInput) livraisonInput.value = livraison;

    const stockDisplay = row.querySelector('[data-name="stock_display"]');
    if (stockDisplay && stock !== null) {
      stockDisplay.textContent = stock;
      stockDisplay.classList.remove("text-success", "text-danger");
      if (parseInt(stock) > 0) {
        stockDisplay.classList.add("text-success");
      } else {
        stockDisplay.classList.add("text-danger");
      }
    }

    const qteInput = row.querySelector('input[name="quantite"]');
    if (qteInput) calculerTotal(qteInput);

    // ‚úÖ Si l'utilisateur vient de modifier un article, on autorise la MAJ auto des frais
    if (!isInit) {
      fraisFromArticlesEnabled = true;
      verifierLivraisonGratuite();
    }
    mettreAJourTotaux();
  }

  function calculerTotal(input) {
    const row = input.closest(".row");
    const pu = parseFloat(row.querySelector('input[name="pu"]').value) || 0;
    const qte = parseInt(row.querySelector('input[name="quantite"]').value) || 0;
    const montant = pu * qte;
    row.querySelector('input[name="montant"]').value = parseInt(montant);
    mettreAJourTotaux();
  }

  // Format affichage 1 000 000
  function formatIntPoint(value) {
    return (value || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  // üîß parser robuste (g√®re espaces)
  function parseNumber(val) {
    if (typeof val !== "string") val = (val ?? "").toString();
    return parseFloat(val.replace(/\s+/g, "")) || 0;
  }

  // Calcul r√©capitulatif total √† payer
  function mettreAJourTotaux() {
    let totalArticles = 0;
    document.querySelectorAll('input[name="montant"]').forEach(input => {
      totalArticles += parseNumber(input.value);
    });

    const fraisLivraison = parseNumber(document.getElementById("frais_livraison").value);
    const totalAPayer = totalArticles + fraisLivraison;

    document.getElementById("total_articles").textContent = formatIntPoint(totalArticles);
    document.getElementById("total_frais_livraison").textContent = formatIntPoint(fraisLivraison);
    document.getElementById("total_a_payer").textContent = formatIntPoint(totalAPayer);
  }

  // ‚ûï Respecte la valeur existante tant que l'utilisateur n'a pas modifi√©/ajout√© un article
  function verifierLivraisonGratuite() {
    if (!fraisFromArticlesEnabled) {
      // Ne pas √©craser la valeur existante au chargement
      return;
    }

    let gratuite = false;
    const fraisLivraisonInput = document.getElementById("frais_livraison");
    const lieuSelect = document.getElementById("lieu");
    const defaultFraisLivraison = lieuSelect.selectedOptions[0]?.getAttribute("data-frais_livraison") || 0;

    document.querySelectorAll('select[name="article"]').forEach(select => {
      const livraison = select.selectedOptions[0]?.getAttribute("data-livraison");
      if (livraison && livraison.trim().toLowerCase() === "gratuite") {
        gratuite = true;
      }
    });

    if (gratuite) {
      fraisLivraisonInput.value = 0;
    } else {
      fraisLivraisonInput.value = defaultFraisLivraison;
    }

    mettreAJourTotaux();
  }

  // G√©rer le changement de lieu : on met √† jour frais_livreur/frais_livraison depuis le lieu
  document.getElementById("lieu").addEventListener("change", function () {
    const selectedOption = this.selectedOptions[0];
    const frais_livreur = selectedOption.getAttribute("data-frais_livreur");
    const frais_livraison = selectedOption.getAttribute("data-frais_livraison");

    if (frais_livreur !== null) {
      document.getElementById("frais_livreur").value = frais_livreur;
    }
    if (frais_livraison !== null) {
      document.getElementById("frais_livraison").value = frais_livraison;
    }

    // Le changement de lieu est une action volontaire : on autorise la r√®gle articles si l'utilisateur modifie ensuite
    // mais ici on ne force pas (on laisse la valeur issue du lieu).
    mettreAJourTotaux();
  });

  // Initialiser √† l'ouverture (sans √©craser les frais existants)
  document.addEventListener("DOMContentLoaded", () => {
    // Recalculer affichage/prix/stock pour chaque ligne EXISTANTE sans toucher aux frais
    document.querySelectorAll('select[name="article"]').forEach(select => {
      mettreAJourPrix(select, { isInit: true });
    });

    // Recalcule si l‚Äôutilisateur modifie manuellement le frais de livraison
    const fraisLivraisonInput = document.getElementById("frais_livraison");
    ["input", "change"].forEach(evt =>
      fraisLivraisonInput.addEventListener(evt, mettreAJourTotaux)
    );

    // Premier calcul des totaux
    mettreAJourTotaux();
  });
</script>

{% endblock %}
