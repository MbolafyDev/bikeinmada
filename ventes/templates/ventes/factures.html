{% load static %}
{% load nombre %}
{% load custom_filters %}
{% load static humanize %}

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Facture – Bike in Mada</title>
<style>
  .rouge{ color:#b64825; font-family: "Segoe UI", Calibri, Arial, sans-serif; }
  .noir{ color:#212529; font-weight:normal; font-family: "Segoe UI", Calibri, Arial, sans-serif; }
  .container{ width:100%; max-width:1200px; padding:0 2rem; box-sizing:border-box; margin:0 auto; }
  .container-fluid{ width:100%; padding:0 2rem; box-sizing:border-box; margin:0 auto; }

  :root{
    /* somme = 100% */
    --w-qty:8%;
    --w-desc:52%;
    --w-unit:20%;
    --w-total:20%;
  }

  body{ margin:0; font-family: "Segoe UI", Calibri, Arial, sans-serif; }

  .header,.info{
    display:flex; justify-content:space-between; align-items:center;
    padding:1rem 0; border-bottom:4px solid #b64825;
  }
  .info-client,.info-paiement{
    display:flex; justify-content:space-between; align-items:flex-start; /* important */
    gap:24px; padding:1rem 0;
  }

  .gauche .logo{ max-width:100px; height:auto; display:block; }
  .droite h2{ margin:0; font-size:64px; color:#b64825; font-weight:bold; font-family: "Segoe UI", Arial Black, Helvetica, sans-serif; }

  /* Table facture aligned + striped */
  .table-aligned{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px; font-family: "Segoe UI", Calibri, Arial, sans-serif; }
  .table-aligned th,.table-aligned td{
    padding:8px 12px; overflow:hidden; text-overflow:ellipsis; vertical-align:middle;
  }
  .table-aligned thead th{ background:#cc9900; color:#fff; font-weight:700; text-align:left; }
  .table-aligned.striped tbody tr:nth-of-type(odd){ background:#fff; }
  .table-aligned.striped tbody tr:nth-of-type(even){ background:#f8f9fa; }
  .table-aligned.striped tbody tr:hover{ background:#e9ecef; }
  .qty{ text-align:center; }
  .unit,.money,.total{ text-align:right; white-space:nowrap; }
  .table-aligned tfoot td{ font-weight:700; text-align:right; border-top:2px solid #b64825; }
  .table-aligned thead th { background-color: #cc9900; border:4px solid #fff;}
  .label-total{ color:#b64825; }
  .mb-16{ margin-bottom:16px; }

  .table-striped{ width:100%; border-collapse:collapse; font-size:14px; font-family: "Segoe UI", Calibri, Arial, sans-serif; }
  .table-striped th,.table-striped td{ padding:8px 12px; border:4px solid #fff; }
  .table-striped thead th{ background:#b64825; border:4px solid #fff; color:#fff; font-weight:bold; }
  .table-striped tbody tr:nth-of-type(odd){ background-color:#fff; }
  .table-striped tbody tr:nth-of-type(even){ background-color:#f4d7cf; }
  .table-striped tbody tr:hover{ background-color:#e9ecef; }
  .qty{ width:60px; text-align:center; }
  .money{ text-align:right; white-space:nowrap; }
  .table-striped tfoot td{ font-weight:bold; text-align:right; }
  .table-striped tfoot .label{ color:#b64825; }
  .table-striped tfoot .total-ttc td{ color:#b64825; font-size:1.1em; }

  .center{ display:flex; justify-content:center; margin-top:1rem; }
  .center p{ text-align:center; font-style:italic; margin:0; }
  .right{ display:flex; justify-content:right; margin-top:1rem; }
  .right p{ text-align:right; font-style:italic; margin:0; font-size: 13px; }
  .table-striped tbody tr td:last-child { background-color: #f4d7cf; }
  .table-striped tfoot tr td:last-child { background-color: #f4d7cf; }

  .center p,
  .right p {
    font-style: italic;
    font-family: "Segoe UI", Calibri, Arial, sans-serif;
  }

  .info-paiement ul {
    margin: 6px 0 0;
    padding-left: 18px;
    list-style-type: none;
  }

  .info-paiement ul li {
    margin-bottom: 4px;
  }

  /* ------- Zone MODE DE PAIEMENT ------- */
  .gauche-flex{ flex:1 1 auto; }

  .droite-flex{
    flex:0 0 40%;           /* largeur de la colonne droite (ajuste si besoin) */
    display:flex;
    gap:0;                  /* blocs collés */
    margin-left:auto;
    height:130px;            /* hauteur unique pour la bande bicolore */
  }

  /* Chaque bloc = 50% exactement */
  .droite-flex .block{
    flex:1 0 50%;
    height:100%;
  }

  .block-vert{  background:#92d14f; }  /* vert doux */
  .block-rouge{ background:#FF8A65; }  /* orange/rouge doux */

  /* Liste paiements plus compacte */
  .info-paiement ul{ margin:6px 0 0; padding-left:18px; }

  .footer {
  text-align: center;
  font-size: 18px;
  color: #555;
  margin-top: 2rem; 
  padding: 1rem 0; 
  font-family: "Segoe UI", Calibri, Arial, sans-serif;
}
.footer p {
  margin: 0.3rem 0;
}

@media print {
  /* Affiche les couleurs de fond et du texte comme à l’écran */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important; 
  }
</style>
</head>
<body>
  <div class="container">
    
    {% for commande in commandes %}
      <section class="header">
          <div class="gauche"><img src="{% static 'images/bikeinmada.png' %}" alt="Logo" class="logo" style="height: 120px;"></div>
      <div class="droite"><h2>Facture</h2></div>
    </section>

    <!-- information -->
    <section class="info">
      <div class="gauche">
        <h3 class="titre" style="color: #b64825;">Bike in Mada <br><small style="font-weight: normal; font-style: italic; color: #b64825;">"The Bike service provider in Madagascar"</small></h3>
        
      </div>
      <div class="droite">
        <h4 class="rouge">Date de facture: <span class="noir">{{ commande.date_commande }}</span></h4>
        <h4 class="rouge">N° de facture: <span class="noir" style="font-weight: bold;">{{ commande.numero_facture }}</span></h4>
        <h4 class="rouge">
          Référence client:
          <span class="noir">
            {% if commande.client.reference_client %}
              {{ commande.client.reference_client }}
            {% else %}—{% endif %}
          </span>
        </h4>
      </div>
    </section>

    <section class="info-client">
      <div class="gauche">
        <h4 class="rouge">À : <span class="noir">{{ commande.client.nom }} <br>{{ commande.client.contact }}</span></h4>
      </div>
      <div class="droite">
        <h4 class="rouge">Début de préstation: <span class="noir">{{ commande.date_debut_prestation }}</span></h4>
        <h4 class="rouge">Fin de préstation: <span class="noir">{{ commande.date_fin_prestation }}</span></h4>
        <h4 class="rouge">Durée de préstation: 
          <span class="noir">
            {% if commande.duree_prestation is not None %}
              {{ commande.duree_prestation }} jour{{ commande.duree_prestation|pluralize:"s" }}
            {% else %}—{% endif %}
          </span></h4>
      </div>
    </section>

    <!-- contenu -->
    <div class="contenu">
      <table class="table  table-aligned mb-16">
        <colgroup>
          <col style="width:var(--w-qty)">
          <col style="width:var(--w-desc)">
          <col style="width:var(--w-unit)">
          <col style="width:var(--w-total)">
        </colgroup>
        <thead>
          <tr>
            <th class="qty">PoS</th>
            <th>Mécanicien</th>
            <th class="money">Conditions de paiement</th>
            <th class="money">Date d’échéance</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>{{ commande.created_by.first_name }}</td>
            <td class="money">{% if commande.vente %}{{ commande.vente.paiement.nom }}{% else %}—{% endif %}</td>
            <td class="money">11-sept.-25</td>
          </tr>
        </tbody>
      </table>

      <table class="table-striped" aria-label="Détails de la facture">
        <colgroup>
          <col style="width:var(--w-qty)">
          <col style="width:var(--w-desc)">
          <col style="width:var(--w-unit)">
          <col style="width:var(--w-total)">
        </colgroup>
        <thead>
          <tr>
            <th class="qty">Qté</th>
            <th>Description</th>
            <th class="money">Prix unitaire</th>
            <th class="money">Total de la ligne</th>
          </tr>
        </thead>
        <tbody>
          
          {% for ligne in commande.lignes_commandes.all %}
            <tr>
              <td>{{ ligne.quantite }}</td>
              <td>{{ ligne.article.nom }}<br><small>{{ ligne.article.reference }}</small></td>
              <td class="money">MGA {{ ligne.prix_unitaire|intcomma }}</td>
              <td class="money">MGA {{ ligne.montant|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="money">Aucune ligne pour cette commande.</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="label">Sous-total :</td>
            <td class="money">MGA {{ commande.montant_commande|intcomma }}</td>
          </tr>
          <tr>
            <td colspan="3" class="label">I.S. :</td>
            <td class="money">
              {% if commande.vente and commande.vente.impot_synthetique %}
                MGA {{ commande.vente.impot_synthetique|intcomma }}
              {% else %}
                MGA 0
              {% endif %}
            </td>
          </tr>
          <tr class="total-ttc">
            <td colspan="3" class="label">Total TTC</td>
            <td class="money">
              {% with ht=commande.montant_commande is=commande.vente.impot_synthetique|default_if_none:0 fl=commande.frais_livraison|default:0 %}
                MGA {{ ht|add:is|add:fl|intcomma }}
              {% endwith %}
            </td>
          </tr>
        </tfoot>
      </table>

      <div class="center">
        <p>Arrêtée à la somme de : {{ commande.montant_commande|int2words }} Ariary</p>
      </div>

      <!-- MODE DE PAIEMENT : 2 blocs = 50/50 -->
      <section class="info-paiement">
        <div class="gauche-flex">
          <h3>MODE DE PAIEMENT :</h3>
          <ul>
            <li>- Au Comptant</li>
            <li>- Virement</li>
            <li>- Par Chèque</li>
          </ul>
        </div>

        <div class="droite-flex">
          <div class="block block-vert"></div>
          <div class="block block-rouge"></div>
        </div>
      </section>

      <div class="center">
        <p><strong>Nous vous remercions de votre confiance!</strong></p>
      </div>
      <div class="right">
        <p>1 Euro = 4700Ar</p>
      </div>
    </div>

    <footer class="footer">
      <p>
        Bike in Mada – Bike Service Provider – Tour Operator <br>
        SSO 23terA Soamanandray, Ambohidratrimo – 105 – Madagascar <br>
        Tel.: +261 34 98 583 55 - travel@bike-in-mada.mg – www.bike-in-mada.mg <br>
        NIF: 3 002 203 732 - STAT : 77302 11 2016 0 01186 - RCS : 2019A02532
      </p>
    </footer>
    {% endfor %}
      
    
  </div>
  {% if impression %}
  <script>
    window.addEventListener('load', function () {
      window.print();
    });
  </script>
  {% endif %}

</body>
</html>
