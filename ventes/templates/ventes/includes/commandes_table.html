{% load nombre %}
{% load static %}

{% if commandes %}
  <div class="d-none d-lg-block">
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary">
          <tr>
            <th>Date</th>
            <th>Facture</th>
            <th>Client</th>
            <th>Lieu</th>
            <th>Articles</th>
            <th>Page</th>
            <th>Encaissement</th>
            <th>Livraison</th>
            <th>Total</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>

        <tbody>
          {% for commande in commandes %}
            <tr {% if commande.statut_publication == 'supprimé' or commande.statut_livraison == "Annulée" or commande.statut_livraison == "Reportée" %}style="text-decoration: line-through;"{% endif %}>
              <td>{{ commande.date_livraison|date:"d/m/Y" }}</td>
              <td>{{ commande.numero_facture }}</td>
              <td>{{ commande.client.nom }}</td>
              <td>{{ commande.client.lieu.lieu }}</td>
              <td>
                <ul class="mb-0">
                  {% for ligne in commande.lignes_commandes.all %}
                    <li>{{ ligne.article.nom }} ({{ ligne.quantite }})</li>
                  {% endfor %}
                </ul>
              </td>
              <td>{{ commande.page }}</td>
              <td>{{ commande.statut_vente }}</td>
              <td>{{ commande.statut_livraison }}</td>
              <td class="text-end">{{ commande.total_commande|intpoint }}</td>
              <td class="text-center" style="white-space: nowrap;">
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        title="Voir"
                        data-bs-toggle="modal"
                        data-bs-target="#ouvrirDetailCommande_{{ commande.id }}">
                  <i class="fa fa-eye"></i>
                </button>

                <!-- EDIT (Table -> prefix Table) -->
                <button type="button"
                        class="btn btn-sm btn-outline-success"
                        title="Modifier"
                        data-bs-toggle="modal"
                        data-bs-target="#commandeEditModalTable-{{ commande.id }}"
                        {% if commande.actions_desactivees %}disabled{% endif %}>
                  <i class="fa fa-edit"></i>
                </button>

                {% if is_admin and commande.statut_publication == "supprimé" %}
                  <button type="button"
                          class="btn btn-sm btn-outline-success"
                          title="Restaurer"
                          data-bs-toggle="modal"
                          data-bs-target="#restoreCommandeModal{{ commande.id }}">
                    <i class="fa fa-undo"></i>
                  </button>
                {% else %}
                  <button type="button"
                          class="btn btn-sm btn-outline-danger"
                          title="Supprimer"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteCommandeModal"
                          data-id="{{ commande.id }}"
                          data-numero="{{ commande.numero_facture }}"
                          data-action="{% url 'commande_delete' commande_id=commande.id %}"
                          {% if not is_admin or commande.actions_desactivees %}disabled{% endif %}>
                    <i class="fa fa-trash"></i>
                  </button>

                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>

        {% if is_admin %}
          <tfoot class="table-primary fw-bold">
            <tr>
              <td colspan="8" class="text-end">Total général :</td>
              <td class="text-end">{{ total_general|intpoint }}</td>
              <td></td>
            </tr>
          </tfoot>
        {% endif %}
      </table>
    </div>
  </div>

  {# ===== Rend les modals d'édition une seule fois pour la table, avec préfixe 'Table' ===== #}
  {% for c in commandes %}
    {% include 'ventes/edit_commande.html' with commande=c lignes=c.lignes_commandes.all articles=articles pages=pages lieux=lieux modal_prefix='Table' %}
  {% endfor %}

{% else %}
  <div class="alert alert-info text-center">Aucune commande enregistrée.</div>
{% endif %}

