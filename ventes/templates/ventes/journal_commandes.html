{% extends "base.html" %}
{% load static %}
{% load nombre %}

{% block extra_css_and_scripts %}
<style>
  .article-list{ overflow-x:hidden; list-style:disc; padding-left:1.25rem; margin-bottom:0; }
  .article-line-inner{ display:flex; flex-wrap:wrap; align-items:flex-start; gap:.5rem; }
  .article-name{ flex:1 1 auto; min-width:0; white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
  .view-toggle .btn{ padding:.375rem .6rem; }
  .view-toggle .btn.active{ pointer-events:none; }
  .thumb-120{ height:120px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:.375rem; }
  .thumb-120 img{ max-height:100%; max-width:100%; object-fit:contain; object-position:center; display:block; background:#fff; }
  .modal-dialog-scrollable .modal-body{ overflow-y:auto !important; max-height:calc(100vh - 6rem); }
  .modal-dialog-scrollable .modal-footer{ position:sticky; bottom:0; background:#fff; z-index:2; border-top:1px solid rgba(0,0,0,.1); }
</style>
{% endblock %}

{% block title %}Journal des commandes{% endblock %}

{% block content %}
<div class="container-fluid mb-2">

  <h2 class="text-center">Journal des commandes</h2>

  {% include "includes/messages_alert.html" %}

  <!-- Barre d'actions -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#commandeCreateModal">
      <i class="fa fa-plus"></i> Nouvelle commande
    </button>

    <div class="d-flex align-items-center gap-2">
      <div class="view-toggle d-none d-lg-flex gap-1"
           data-storage-key="zr_display_commandes"
           data-target-url="{% url 'liste_commandes_partial' %}"
           data-target="#commandes-table-wrapper">
        <button type="button"
                class="btn btn-outline-success {% if display_mode == 'table' %}active{% endif %}"
                data-mode="table" title="Mode Tableau">
          <i class="fa fa-table"></i>
        </button>
        <button type="button"
                class="btn btn-outline-success {% if display_mode == 'cards' %}active{% endif %}"
                data-mode="cards" title="Mode Cartes">
          <i class="fa fa-credit-card"></i>
        </button>
      </div>

      <button class="btn btn-outline-success d-lg-none" type="button"
              data-bs-toggle="collapse" data-bs-target="#filtersCollapse"
              aria-expanded="false" aria-controls="filtersCollapse">
        <i class="fa fa-filter"></i>
      </button>
    </div>
  </div>

  <!-- Filtres -->
  <div id="filtersCollapse" class="collapse d-lg-block">
    <div class="row m-1">
      <form id="filtersForm" method="get" class="row g-2 mb-2"
            hx-get="{% url 'liste_commandes_partial' %}"
            hx-target="#commandes-table-wrapper"
            hx-push-url="true"
            hx-trigger="change delay:300ms, submit">

        <!-- Date livraison -->
        <div class="col-md-6 col-lg-2">
          <label for="date_livraison" class="form-label fw-bold d-none d-lg-block">Date de livraison</label>
          <div class="input-group">
            <span class="input-group-text d-lg-none"><i class="fa fa-calendar"></i></span>
            <input type="date" name="date_livraison" id="date_livraison" class="form-control"
                   value="{{ filtre_date_livraison }}">
          </div>
        </div>

        <!-- Article -->
        <div class="col-md-6 col-lg-3">
          <label for="article_id" class="form-label fw-bold d-none d-lg-block">Article</label>
          <div class="input-group">
            <span class="input-group-text d-lg-none"><i class="fa fa-box-open"></i></span>
            <select name="article_id" id="article_id" class="form-select">
              <option value="">Tous les articles</option>
              {% for a in articles %}
                <option value="{{ a.id }}" {% if filtre_article_id == a.id|stringformat:"s" %}selected{% endif %}>
                  {{ a.nom }}
                  {% if a.categorie %}- {{ a.categorie.categorie }}{% endif %}
                  {% if a.taille %}- {{ a.taille.taille }}{% endif %}
                  {% if a.couleur %}- {{ a.couleur.couleur }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Page -->
        <div class="col-md-6 col-lg-2">
          <label for="page_id_filter" class="form-label fw-bold d-none d-lg-block">Page</label>
          <div class="input-group">
            <span class="input-group-text d-lg-none"><i class="fa fa-shop"></i></span>
            <select name="page_id_filter" id="page_id_filter" class="form-select">
              <option value="">Toutes les pages</option>
              {% for p in pages %}
                <option value="{{ p.id }}" {% if filtre_page == p.id|stringformat:"s" %}selected{% endif %}>
                  {{ p.nom }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Statut vente -->
        <div class="col-md-6 col-lg-2">
          <label for="statut_vente" class="form-label fw-bold d-none d-lg-block">Statut vente</label>
          <div class="input-group">
            <span class="input-group-text d-lg-none"><i class="fa fa-wallet"></i></span>
            <select name="statut_vente" id="statut_vente" class="form-select">
              <option value="">Tous les encaissements</option>
              <option value="En attente" {% if filtre_statut_vente == "En attente" %}selected{% endif %}>En attente</option>
              <option value="Pay√©e" {% if filtre_statut_vente == "Pay√©e" %}selected{% endif %}>Pay√©e</option>
              <option value="Annul√©e" {% if filtre_statut_vente == "Annul√©e" %}selected{% endif %}>Annul√©e</option>
              <option value="Supprim√©e" {% if filtre_statut_vente == "Supprim√©e" %}selected{% endif %}>Supprim√©e</option>
            </select>
          </div>
        </div>

        <!-- Statut livraison -->
        <div class="col-md-6 col-lg-2">
          <label for="statut_livraison" class="form-label fw-bold d-none d-lg-block">Statut livraison</label>
          <div class="input-group">
            <span class="input-group-text d-lg-none"><i class="fa fa-bicycle"></i></span>
            <select name="statut_livraison" id="statut_livraison" class="form-select">
              <option value="">Toutes les livraisons</option>
              <option value="En attente"   {% if filtre_statut_livraison == "En attente" %}selected{% endif %}>En attente</option>
              <option value="Planifi√©e"    {% if filtre_statut_livraison == "Planifi√©e" %}selected{% endif %}>Planifi√©e</option>
              <option value="Livr√©e"       {% if filtre_statut_livraison == "Livr√©e" %}selected{% endif %}>Livr√©e</option>
              <option value="Annul√©e"      {% if filtre_statut_livraison == "Annul√©e" %}selected{% endif %}>Annul√©e</option>
              <option value="Report√©e"     {% if filtre_statut_livraison == "Report√©e" %}selected{% endif %}>Report√©e</option>
              <option value="Supprim√©e"    {% if filtre_statut_livraison == "Supprim√©e" %}selected{% endif %}>Supprim√©e</option>
            </select>
          </div>
        </div>

        <!-- Bouton -->
        <div class="col-md-6 col-lg-1 d-flex align-items-end">
          <button type="submit" class="btn btn-outline-success w-100">
            <i class="fa fa-filter"></i> Filtrer
          </button>
        </div>

        <input type="hidden" name="display" id="display_input" value="{{ display_mode }}">
        <input type="hidden" name="page" id="page_input" value="{{ page_obj.number }}">
      </form>
    </div>
  </div>

  {% include "ventes/includes/commandes_list_wrapper.html" %}
  {% include "common/includes/pagination.html" with page_obj=page_obj extra_querystring=extra_querystring %}

  {% for commande in commandes %}
    {% include "ventes/includes/commande_detail_modal_content.html" with commande=commande %}
    {% include "ventes/includes/modal_restauration_commande.html" %}
  {% endfor %}

  <!-- Modal de confirmation de suppression -->
  <div class="modal fade" id="deleteCommandeModal" tabindex="-1" aria-labelledby="deleteCommandeLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="deleteCommandeForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="deleteCommandeLabel">Supprimer la commande</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            √ätes-vous s√ªr de vouloir supprimer la commande relative √† la facture <strong id="commandeNum"></strong> ?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-danger">Supprimer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>

{# ====== Donn√©es ARTICLES ====== #}
<script>
  {% if articles_json %}
    const ARTICLES = {{ articles_json|safe }};
  {% else %}
    const ARTICLES = [
      {% for a in articles %}
        {
          "id": {{ a.id }},
          "nom": "{{ a.nom|escapejs }}",
          "categorie": "{{ a.categorie.categorie|default_if_none:''|escapejs }}",
          "taille": "{{ a.taille.taille|default_if_none:''|escapejs }}",
          "couleur": "{{ a.couleur.couleur|default_if_none:''|escapejs }}",
          "livraison": "{{ a.livraison|default_if_none:''|escapejs }}",
          "prix_vente": {{ a.prix_vente|default:0 }},
          "prix_achat": {{ a.prix_achat|default:0 }},
          "stock": {{ a.stock_final|default:0 }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
  {% endif %}
</script>

<script>
(function(){
  const safe = v => (v ?? '') + '';
  const fmt = n => (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  const parseN = v => {
    if (typeof v !== 'string') v = (v ?? '').toString();
    return parseFloat(v.replace(/\s+/g,'')) || 0;
  };

  function buildLineHtml(){
    const options = ARTICLES.map(a => {
      const lib = [safe(a.nom), safe(a.taille), safe(a.couleur)]
        .filter(Boolean).join(' - ');
      return `
        <option value="${a.id}"
                data-prix="${safe(a.prix_vente)}"
                data-stock="${safe(a.stock)}"
                data-livraison="${safe(a.livraison)}">
          ${lib}
        </option>`;
    }).join('');

    return `
      <div class="row g-3 align-items-end mb-3" data-line>
        <div class="col-lg-3">
          <label class="form-label">Article</label>
          <select name="article" class="form-select" required data-role="article">
            <option value="">-- Choisir --</option>
            ${options}
          </select>
        </div>
        <div class="col-lg-2">
          <label class="form-label">P.U</label>
          <input type="number" name="pu" class="form-control" step="100">
        </div>
        <div class="col-lg-1">
          <label class="form-label">Qt√©</label>
          <input type="number" name="quantite" class="form-control" value="1" min="1">
        </div>
        <div class="col-lg-1">
          <label class="form-label">Stock</label>
          <div data-name="stock_display" class="form-control-plaintext fw-bold text-center">-</div>
        </div>
        <div class="col-lg-2">
          <label class="form-label">Livraison</label>
          <input type="text" name="livraison" class="form-control" readonly>
        </div>
        <div class="col-lg-2">
          <label class="form-label">Montant</label>
          <input type="number" name="montant" class="form-control" readonly>
        </div>
        <div class="col-lg-1 d-grid">
          <button type="button" class="btn btn-danger btn-sm" data-action="remove-line">‚úñ</button>
        </div>
      </div>`;
  }

  function handleModalUpdate(modalEl){
    const instance = bootstrap.Modal.getOrCreateInstance(modalEl);
    if(instance && typeof instance.handleUpdate==='function'){ instance.handleUpdate(); }
  }
  function scrollModalBodyToBottom(modalEl){
    const body = modalEl.querySelector('.modal-body');
    if(!body) return;
    requestAnimationFrame(()=> body.scrollTo({ top: body.scrollHeight, behavior: 'smooth' }));
  }

  window.initCommandeModalByElement = function(modal, prefix){
    if (!modal) return;

    const root   = modal;
    const lignes = root.querySelector(`#${prefix}_lignesCommande`);
    const addBtn = root.querySelector('[data-action="add-line"]');

    const selLieu          = root.querySelector('select[name="lieu"]');
    const inFraisLivraison = root.querySelector('input[name="frais_livraison"]');
    const inFraisLivreur   = root.querySelector('input[name="frais_livreur"]');

    function majTotaux(){
      let totalArticles = 0;
      root.querySelectorAll('input[name="montant"]').forEach(inp => totalArticles += parseN(inp.value));
      const fl = parseN(inFraisLivraison?.value || 0);
      const total = totalArticles + fl;

      const ta  = root.querySelector('[data-name="total_articles"]');
      const tfl = root.querySelector('[data-name="total_frais_livraison"]');
      const tap = root.querySelector('[data-name="total_a_payer"]');
      if(ta)  ta.textContent  = fmt(totalArticles);
      if(tfl) tfl.textContent = fmt(fl);
      if(tap) tap.textContent = fmt(total);
    }

    function verifLivraisonGratuite(){
      const defaultFL = selLieu?.selectedOptions?.[0]?.getAttribute('data-frais_livraison') || 0;
      let gratuite = false;
      root.querySelectorAll('select[name="article"]').forEach(s=>{
        const liv = s.selectedOptions?.[0]?.getAttribute('data-livraison') || '';
        if(liv.trim().toLowerCase() === 'gratuite') gratuite = true;
      });
      if(inFraisLivraison){
        inFraisLivraison.value = gratuite ? 0 : defaultFL;
      }
      majTotaux();
    }

    function calcLigne(row){
      const pu  = parseN(row.querySelector('input[name="pu"]').value);
      const qte = parseN(row.querySelector('input[name="quantite"]').value);
      row.querySelector('input[name="montant"]').value = Math.trunc((pu||0) * (qte||0));
      majTotaux();
    }

    function onArticleChange(select){
      const opt = select.selectedOptions[0];
      const row = select.closest('[data-line]') || select.closest('.row');
      if(!opt || !row) return;

      const pu   = opt.getAttribute('data-prix');
      const stk  = parseInt(opt.getAttribute('data-stock'))||0;
      const livr = opt.getAttribute('data-livraison')||'';

      row.querySelector('input[name="pu"]').value        = pu || '';
      row.querySelector('input[name="livraison"]').value = livr;

      const stockDisplay = row.querySelector('[data-name="stock_display"]');
      if(stockDisplay){
        stockDisplay.textContent = stk;
        stockDisplay.classList.toggle('text-success', stk>0);
        stockDisplay.classList.toggle('text-danger',  stk<=0);
      }
      calcLigne(row);
      verifLivraisonGratuite();
    }

    function addLine(){
      if(!lignes) return;
      lignes.insertAdjacentHTML('beforeend', buildLineHtml());
      handleModalUpdate(modal);
      scrollModalBodyToBottom(modal);
    }

    addBtn?.addEventListener('click', addLine);

    root.addEventListener('click', (e)=>{
      if(e.target.matches('[data-action="remove-line"]')){
        const row = e.target.closest('[data-line]') || e.target.closest('.row');
        row?.remove();
        verifLivraisonGratuite();
        majTotaux();
        handleModalUpdate(modal);
      }
    });

    root.addEventListener('change', (e)=>{
      if(e.target.matches('select[name="article"]')) onArticleChange(e.target);

      if(e.target.matches('input[name="pu"], input[name="quantite"]')){
        const row = e.target.closest('[data-line]') || e.target.closest('.row');
        calcLigne(row); handleModalUpdate(modal);
      }

      if(e.target === selLieu){
        const opt = selLieu.selectedOptions?.[0];
        const fL  = opt?.getAttribute('data-frais_livraison');
        const fR  = opt?.getAttribute('data-frais_livreur');
        if(inFraisLivraison && fL !== null) inFraisLivraison.value = fL;
        if(inFraisLivreur   && fR !== null) inFraisLivreur.value   = fR;
        verifLivraisonGratuite(); handleModalUpdate(modal);
      }
    });

    ['input','change'].forEach(evt =>
      inFraisLivraison?.addEventListener(evt, ()=>{ majTotaux(); handleModalUpdate(modal); })
    );

    modal.addEventListener('shown.bs.modal', ()=>{
      handleModalUpdate(modal);
      if(lignes && !lignes.querySelector('[data-line]') && prefix === 'create'){
        addLine();
      }
      root.querySelectorAll('[data-line]').forEach(row => calcLigne(row));
      verifLivraisonGratuite();
      majTotaux();
      scrollModalBodyToBottom(modal);
    });

    const form = root.querySelector('form');
    if(form){
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        btn?.setAttribute('disabled','disabled');
        try{
          const resp = await fetch(form.action, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}, body:new FormData(form) });
          if(resp.ok){
            bootstrap.Modal.getOrCreateInstance(modal).hide();
            const url = "{{ request.build_absolute_uri|slice:':-1' }}{% url 'liste_commandes_partial' %}";
            if(window.htmx){
              htmx.ajax('GET', url, { target:'#commandes-table-wrapper', swap:'outerHTML' });
            }else{
              window.location.reload();
            }
          }else{
            const html = await resp.text();
            const tmp = document.createElement('div'); tmp.innerHTML = html;
            const sameId = modal.getAttribute('id');
            const replacement = tmp.querySelector(`#${CSS.escape(sameId)}`);
            if(replacement){
              modal.replaceWith(replacement);
              initCommandeModalByElement(replacement, prefix);
              bootstrap.Modal.getOrCreateInstance(replacement).show();
            }else{
              alert("Impossible d'enregistrer la commande (r√©ponse inattendue).");
            }
          }
        }catch(err){
          console.error(err);
          alert("Erreur r√©seau lors de l'enregistrement.");
        }finally{
          btn?.removeAttribute('disabled');
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const create = document.getElementById('commandeCreateModal');
    if (create) initCommandeModalByElement(create, 'create');

    document.querySelectorAll('[id^="commandeEditModal"]').forEach(m => {
      initCommandeModalByElement(m, 'edit');
    });
  });
})();
</script>

<script>
document.addEventListener('show.bs.modal', function (e) {
  const m = e.target;
  if (m && m.id === 'deleteCommandeModal') {
    const btn = e.relatedTarget;
    if (!btn) return;

    const action = btn.getAttribute('data-action');
    const numero = btn.getAttribute('data-numero') || '';

    const form = m.querySelector('#deleteCommandeForm');
    const span = m.querySelector('#commandeNum');

    if (form && action) form.action = action;
    if (span) span.textContent = numero;
  }
});
</script>

<script>
(function(){
  const toggle = document.querySelector('.view-toggle');
  if(!toggle) return;

  const STORAGE_KEY = toggle.getAttribute('data-storage-key') || 'zr_display_commandes';
  const TARGET      = toggle.getAttribute('data-target') || '#commandes-table-wrapper';
  const TARGET_URL  = toggle.getAttribute('data-target-url');

  const form        = document.getElementById('filtersForm');
  const inputDisplay= document.getElementById('display_input');
  const inputPage   = document.getElementById('page_input');

  function setActive(mode){
    toggle.querySelectorAll('button[data-mode]').forEach(b=>{
      b.classList.toggle('active', b.getAttribute('data-mode') === mode);
    });
  }

  function reloadList(mode){
    if(inputDisplay) inputDisplay.value = mode;
    if(inputPage)    inputPage.value    = 1;
    localStorage.setItem(STORAGE_KEY, mode);
    setActive(mode);

    const params = new URLSearchParams(new FormData(form));
    params.set('display', mode);
    params.set('page', '1');

    const url = TARGET_URL + '?' + params.toString();

    if (window.htmx) {
      htmx.ajax('GET', url, { target: TARGET, swap: 'outerHTML', pushUrl: true });
    } else {
      window.location.href = url;
    }
  }

  toggle.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-mode]');
    if(!btn) return;
    const mode = btn.getAttribute('data-mode');
    if(!mode) return;
    e.preventDefault();
    reloadList(mode);
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved && inputDisplay && inputDisplay.value !== saved){
      setActive(saved);
    }else{
      setActive(inputDisplay?.value || 'table');
    }
  });
})();
</script>

<script>
  document.body.addEventListener('htmx:afterSwap', function (e) {
    const tgt = e.target;
    if (!tgt) return;

    if (tgt.id === 'commandes-table-wrapper') {
      const create = document.getElementById('commandeCreateModal');
      if (create) initCommandeModalByElement(create, 'create');

      document.querySelectorAll('[id^="commandeEditModal"]').forEach(m => {
        initCommandeModalByElement(m, 'edit');
      });

      // üîÅ Rebind autocomplete apr√®s swap
      bindNameAutocomplete();
    }
  }, false);
</script>

<!-- ===== Autocomplete clients (avec reset imm√©diat) ===== -->
<script>
// utils
function debounce(fn, delay=300){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
}
const JSON_OK = res => res.ok && (res.headers.get('Content-Type')||'').includes('application/json');

// cache
const CLIENT_SUGGEST_CACHE = Object.create(null);

// vider les champs li√©s au client
function clearClientFields() {
  const contactEl  = document.getElementById('create_contact');
  const refEl      = document.getElementById('create_reference_client');
  const lieuEl     = document.getElementById('create_lieu');
  const precEl     = document.getElementById('create_precision_lieu');
  const flEl       = document.getElementById('create_frais_livraison');
  const frEl       = document.getElementById('create_frais_livreur');

  if (contactEl) contactEl.value = '';
  if (refEl)     refEl.value     = '';
  if (precEl)    precEl.value    = '';

  if (lieuEl) {
    lieuEl.value = '';
    lieuEl.dispatchEvent(new Event('change', { bubbles:true }));
  }

  if (flEl) flEl.value = '';
  if (frEl) frEl.value = '';
}

// datalist suggestions
async function fetchClientSuggestions(q){
  try {
    const res = await fetch(`/ventes/client-suggest/?q=${encodeURIComponent(q)}`,
      { headers: { 'X-Requested-With':'XMLHttpRequest' }});
    if (!JSON_OK(res)) return [];
    const data = await res.json();
    return Array.isArray(data.results) ? data.results : [];
  } catch(e) {
    console.warn('client-suggest error', e);
    return [];
  }
}

function ensureDatalist(){
  // on s'assure qu'un <datalist id="clients_datalist"> existe, sinon on le cr√©e
  let listEl = document.getElementById('clients_datalist');
  if (!listEl){
    listEl = document.createElement('datalist');
    listEl.id = 'clients_datalist';
    document.body.appendChild(listEl);
  }
  // on s'assure que l'input nom pointe vers ce datalist
  const nomEl = document.getElementById('create_nom');
  if (nomEl && !nomEl.getAttribute('list')) nomEl.setAttribute('list','clients_datalist');
  return listEl;
}

function fillDatalist(listEl, items){
  if (!listEl) return;
  listEl.innerHTML = '';
  const seen = new Set();
  for (const c of items){
    const key = (c.nom || '').trim().toLowerCase();
    if (!key || seen.has(key)) continue;
    seen.add(key);
    CLIENT_SUGGEST_CACHE[key] = c;
    const opt = document.createElement('option');
    opt.value = c.nom || '';
    if (c.contact) opt.label = `${c.nom} ‚Äî ${c.contact}`;
    listEl.appendChild(opt);
  }
}

// auto-remplissage depuis nom
async function autoFillFromName(){
  const nomEl = document.getElementById('create_nom');
  if (!nomEl) return;
  const nom = (nomEl.value || '').trim();
  if (!nom) return;

  const lower = nom.toLowerCase();
  let c = CLIENT_SUGGEST_CACHE[lower];

  if (!c) {
    try {
      const res = await fetch(`/ventes/client-lookup/?nom=${encodeURIComponent(nom)}&contact=`,
        { headers: { 'X-Requested-With':'XMLHttpRequest' }});
      if (!JSON_OK(res)) return;
      const data = await res.json();
      if (data?.found) c = data.client;
    } catch(e) {
      console.warn('client-lookup error', e);
      return;
    }
  }
  if (!c) return;

  const contactEl   = document.getElementById('create_contact');
  const refEl       = document.getElementById('create_reference_client');
  const lieuEl      = document.getElementById('create_lieu');
  const precLieuEl  = document.getElementById('create_precision_lieu');

  if (contactEl && !contactEl.value)     contactEl.value   = c.contact || '';
  if (refEl && !refEl.value)             refEl.value       = c.reference_client || '';
  if (precLieuEl && !precLieuEl.value)   precLieuEl.value  = c.precision_lieu || '';

  if (lieuEl && c.lieu_id && !lieuEl.value) {
    const targetVal = String(c.lieu_id);
    const hasOption = Array.from(lieuEl.options).some(o => o.value === targetVal);
    if (hasOption) {
      lieuEl.value = targetVal;
      lieuEl.dispatchEvent(new Event('change', { bubbles:true }));
    }
  }
}

// binding
function bindNameAutocomplete(){
  const nomEl = document.getElementById('create_nom');
  if (!nomEl) return;

  const listEl = ensureDatalist();

  // --- handler DEBOUNC√â (requ√™tes + suggestions) ---
  const onTypeDebounced = debounce(async ()=>{
    const q = (nomEl.value || '').trim();

    if (q.length === 0){
      listEl.innerHTML = '';
      clearClientFields();           // ‚úÖ reset champs li√©s
      return;
    }
    if (q.length < 2){
      listEl.innerHTML = '';
      return;
    }
    const items = await fetchClientSuggestions(q);
    fillDatalist(listEl, items);
  }, 250);

  // --- handler IMM√âDIAT (reset instantan√© √† l'effacement) ---
  const onTypeImmediate = ()=>{
    const q = (nomEl.value || '').trim();
    if (q.length === 0){
      // reset imm√©diat (sans attendre le debounce)
      listEl.innerHTML = '';
      clearClientFields();           // ‚úÖ reset imm√©diat
    }
  };

  // nettoyer anciens handlers si rebind
  if (nomEl._inputSuggestImmediate) nomEl.removeEventListener('input', nomEl._inputSuggestImmediate);
  if (nomEl._inputSuggestDebounced) nomEl.removeEventListener('input', nomEl._inputSuggestDebounced);
  if (nomEl._blurAutofillHandler)   nomEl.removeEventListener('blur',  nomEl._blurAutofillHandler);
  if (nomEl._changeAutofillHandler) nomEl.removeEventListener('change',nomEl._changeAutofillHandler);

  // brancher
  nomEl.addEventListener('input', onTypeImmediate);   // imm√©diat
  nomEl._inputSuggestImmediate = onTypeImmediate;

  nomEl.addEventListener('input', onTypeDebounced);   // suggestions/serveur
  nomEl._inputSuggestDebounced = onTypeDebounced;

  const blurH = ()=>{
    const q = (nomEl.value || '').trim();
    if (q.length === 0) {
      clearClientFields();          // ‚úÖ reset aussi au blur si vide
    } else {
      autoFillFromName();
    }
  };
  nomEl.addEventListener('blur', blurH);
  nomEl._blurAutofillHandler = blurH;

  const changeH = debounce(autoFillFromName, 10);
  nomEl.addEventListener('change', changeH);
  nomEl._changeAutofillHandler = changeH;
}

document.addEventListener('DOMContentLoaded', bindNameAutocomplete);

// apr√®s HTMX swap
document.body.addEventListener('htmx:afterSwap', (e)=>{
  if (e.target?.id === 'commandes-table-wrapper'){
    bindNameAutocomplete();
  }
});

// √† l‚Äôouverture de la modale
document.getElementById('commandeCreateModal')
  ?.addEventListener('shown.bs.modal', bindNameAutocomplete);
</script>

{% include 'ventes/creer_commande.html' %}
{% endblock %}
