{% extends "base.html" %}
{% load static %}
{% load nombre %}
{% load extras %}

{% block title %}Statistiques{% endblock %}

{% block css_files %}
  <style>
  #statsSidebar .list-group-item.active {
    background-color: #198754;
    border-color: #198754;
    color: #fff;
    font-weight: 600;
  }
  #statsSidebar .list-group-item.active i { color: #fff; }
</style>
{% endblock css_files %}

{% block content %}

{% now "Y" as cur_year %}
{% now "m" as cur_month %}

<div class="container-fluid mb-3">
  {% comment %} <h2 class="text-center my-3">Statistiques</h2> {% endcomment %}

  <div class="row g-3">
    <!-- Sidebar -->
    <div class="col-12 col-lg-4 col-xl-3">
      <nav id="statsSidebar" class="list-group position-sticky" style="top: 80px;">
        <a href="{% url 'statistiques' %}?tab=rapport"
           class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if active_tab == 'rapport' %}active {% endif %}"
           hx-get="{% url 'statistiques_section' 'rapport' %}?{{ request.GET.urlencode }}"
           hx-target="#statsContent"
           hx-swap="innerHTML"
           hx-push-url="true"
           hx-vals='{"year":"{{ year|default:cur_year }}","month":"{{ month|default:cur_month }}"}'>
          <i class="fa fa-chart-line"></i> Rapport de vente
        </a>

        <a href="{% url 'statistiques' %}?tab=compte"
           class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if active_tab == 'compte' %}active {% endif %}"
           hx-get="{% url 'statistiques_section' 'compte' %}?{{ request.GET.urlencode }}"
           hx-target="#statsContent"
           hx-swap="innerHTML"
           hx-push-url="true">
          <i class="fa fa-table"></i> Compte de résultat
        </a>

        <a href="{% url 'statistiques' %}?tab=bilan"
           class="list-group-item list-group-item-action d-flex align-items-center gap-2 {% if active_tab == 'bilan' %}active {% endif %}"
           hx-get="{% url 'statistiques_section' 'bilan' %}?{{ request.GET.urlencode }}"
           hx-target="#statsContent"
           hx-swap="innerHTML"
           hx-push-url="true">
          <i class="fa fa-balance-scale"></i> Bilan
        </a>
      </nav>
    </div>

    <!-- Content -->
    <div class="col-12 col-lg-8 col-xl-9">
      <div id="statsContent">
        {# Rendu initial (SSR) pour le tab actif #}
        {% if active_tab == 'compte' %}
          {% include "statistiques/compte_de_resultat.html" %}
        {% elif active_tab == 'bilan' %}
          {% include "statistiques/bilan.html" %}
        {% else %}
          {% include "statistiques/rapport_vente.html" %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script_files %}
  <script>
  document.body.addEventListener('htmx:afterOnLoad', function (e) {
    // Ne traite que les swaps qui ont touché la zone stats
    if (!document.querySelector('#statsContent')?.contains(e.detail.target)) return;

    // Reconstruire l'URL de la requête HTMX pour récupérer ?tab=...
    const base = window.location.origin;
    const qs = e.detail.pathInfo.requestParameters
      ? '?' + new URLSearchParams(e.detail.pathInfo.requestParameters)
      : '';
    const url = new URL(e.detail.pathInfo.requestPath + qs, base);
    const tab = url.searchParams.get('tab');

    // Mettre à jour l'actif
    document.querySelectorAll('#statsSidebar a').forEach(a => a.classList.remove('active'));
    const activeLink =
      (tab && document.querySelector(`#statsSidebar a[href$="tab=${tab}"]`)) ||
      (tab && document.querySelector(`#statsSidebar a[href$="/${tab}"]`));
    if (activeLink) activeLink.classList.add('active');
  });
</script>
{% endblock script_files %}
