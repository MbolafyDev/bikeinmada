{# achats/includes/achats_table.html #}
{% load nombre %}

{% if achats %}
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
      <thead class="table-primary">
        <tr>
          <th>Date</th>
          <th>Facture</th>
          <th>Articles</th>
          <th>Paiement</th>
          <th>Remarque</th>
          <th class="text-end">Total</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for achat in achats %}
          <tr {% if achat.statut_publication == 'supprimé' %}style="text-decoration: line-through;"{% endif %}>
            <td>{{ achat.date|date:"d/m/Y" }}</td>
            <td>{{ achat.num_facture|default:"-" }}</td>
            <td>
              <ul class="mb-0 list-unstyled ps-0">
                {% for ligne in achat.lignes_achats.all %}
                  <li>{{ ligne.article.nom }} ({{ ligne.quantite }} × {{ ligne.pu|intpoint }})</li>
                {% endfor %}
              </ul>
            </td>
            <td>{{ achat.paiement.nom }}</td>
            <td>{{ achat.remarque|default:"-" }}</td>
            <td class="text-end">{{ achat.total|intpoint }}</td>
            <td class="text-center" style="white-space: nowrap">
              <div class="d-flex align-items-center justify-content-center">
                <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#ouvrirDetailAchat_{{ achat.id }}">
                  <i class="fa fa-eye"></i>
                </button>
                <form action="{% url 'achat_edit' achat.id %}" method="get" class="me-1">
                  <button class="btn btn-sm btn-outline-success" {% if not is_admin or achat.statut_publication == 'supprimé' %}disabled{% endif %}>
                    <i class="fa fa-edit"></i>
                  </button>
                </form>
                {% if achat.statut_publication == "supprimé" and is_admin %}
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fa fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteDefAchatModal" data-id="{{ achat.id }}" data-numero="{{ achat.num_facture }}">Suppr. déf.</a></li>
                      <li><a class="dropdown-item text-primary" data-bs-toggle="modal" data-bs-target="#restoreAchatModal{{ achat.id }}">Restaurer</a></li>
                    </ul>
                  </div>
                {% else %}
                  <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAchatModal" data-id="{{ achat.id }}" data-numero="{{ achat.num_facture }}" {% if not is_admin %}disabled{% endif %}>
                    <i class="fa fa-trash"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
        <tr class="table-primary fw-bold">
          <td colspan="5" class="text-end">Total des achats</td>
          <td class="text-end">{{ total_achats|intpoint }}</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-info text-center">Aucun achat enregistré.</div>
{% endif %}
