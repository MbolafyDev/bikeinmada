{# livraison/liste_livraisons.html #}
{% extends "base.html" %}
{% load static %}
{% load nombre %}

{% block title %}Liste des livraisons{% endblock %}
{% block content %}
<div class="container mb-2">

  <h2 class="mb-2 text-center">Liste des livraisons</h2>

  {% include "includes/messages_alert.html" %}

    <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap">
        <!-- Boutons à gauche, en ligne -->
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <a class="btn btn-success"
            href="{% url 'planification_livraison' %}" {% if not is_admin %}disabled{% endif %}>
            <i class="fa fa-bicycle me-1"></i> Planification
            </a>

            <a class="btn btn-outline-success"
            href="{% url 'mise_a_jour_statuts_livraisons' %}" {% if not is_admin %}disabled{% endif %}>
            <i class="fa fa-upload me-1"></i> Màj statuts
            </a>

            <!-- <a href="{% url 'liste_livreurs' %}" class="btn btn-outline-success">
            Liste des livreurs
            </a> -->

            <a href="{% url 'frais_livraison_list' %}" class="btn btn-outline-success">
            Lieux et frais
            </a>
        </div>

        <!-- Toggle à l'extrême droite (visible ≥ lg) -->
        <div class="ms-auto d-none d-lg-flex align-items-center view-toggle gap-1"
            data-storage-key="zr_display_livraisons"
            data-target-url="{% url 'liste_livraisons_partial' %}"
            data-target="#livraisonsTableContainer">
            <button type="button"
                    class="btn btn-outline-success {% if display_mode == 'table' %}active{% endif %}"
                    data-mode="table" title="Mode Tableau">
            <i class="fa fa-table"></i>
            </button>
            <button type="button"
                    class="btn btn-outline-success {% if display_mode == 'cards' %}active{% endif %}"
                    data-mode="cards" title="Mode Cartes">
            <i class="fa fa-credit-card"></i>
            </button>
        </div>
    </div>

  <!-- Formulaire de filtre -->
  <div class="row m-1">
    <form id="livraisonsFiltersForm" method="get" class="row g-2 mb-2"
          hx-get="{% url 'liste_livraisons_partial' %}"
          hx-target="#livraisons-wrapper"
          hx-trigger="change delay:300ms, submit"
          hx-push-url="true">

      <!-- Date livraison -->
      <div class="col-md-6 col-lg-3">
        <label for="date" class="form-label fw-bold d-none d-lg-block">Date de livraison</label>
        <div class="input-group">
          <span class="input-group-text d-lg-none"><i class="fa fa-calendar"></i></span>
          <input type="date" name="date" id="date" class="form-control" value="{{ selected_date }}">
        </div>
      </div>

      <!-- Livreur -->
      <div class="col-md-6 col-lg-3">
        <label for="livreur" class="form-label fw-bold d-none d-lg-block">Livreur</label>
        <div class="input-group">
          <span class="input-group-text d-lg-none"><i class="fa fa-user"></i></span>
          <select name="livreur" id="livreur" class="form-select">
            <option value="">Tous les livreurs</option>
            {% for livreur in livreurs %}
              <option value="{{ livreur.id }}" {% if livreur.id|stringformat:"s" == selected_livreur %}selected{% endif %}>
                {{ livreur.nom }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Statut livraison -->
      <div class="col-md-6 col-lg-4">
        <label for="statut_livraison" class="form-label fw-bold d-none d-lg-block">Statut livraison</label>
        <div class="input-group">
          <span class="input-group-text d-lg-none"><i class="fa fa-bicycle"></i></span>
          <select name="statut_livraison" id="statut_livraison" class="form-select">
            <option value="">Tous les statuts</option>
            <option value="En attente"  {% if selected_statut == "En attente" %}selected{% endif %}>En attente</option>
            <option value="Planifiée"   {% if selected_statut == "Planifiée" %}selected{% endif %}>Planifiée</option>
            <option value="Livrée"      {% if selected_statut == "Livrée" %}selected{% endif %}>Livrée</option>
            <option value="Annulée"     {% if selected_statut == "Annulée" %}selected{% endif %}>Annulée</option>
            <option value="Reportée"    {% if selected_statut == "Reportée" %}selected{% endif %}>Reportée</option>
            <option value="Supprimée"   {% if selected_statut == "Supprimée" %}selected{% endif %}>Supprimée</option>
          </select>
        </div>
      </div>

      <!-- Bouton -->
      <div class="col-md-6 col-lg-2 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-success w-100">
          <i class="fa fa-filter"></i> Filtrer
        </button>
      </div>

      <!-- Champs cachés (préserver mode & pagination) -->
      <input type="hidden" name="display" id="display_input" value="{{ display_mode }}">
      <input type="hidden" name="page" id="page_input" value="{{ page_obj.number }}">
    </form>
  </div>

  <!-- Wrapper HTMX (bascule table/cartes) -->
  <div id="livraisons-wrapper"
       hx-get="{% url 'liste_livraisons_partial' %}?{{ request.GET.urlencode }}"
       hx-target="#livraisons-wrapper"
       hx-swap="outerHTML"
       hx-trigger="load">
    {% include "livraison/includes/livraisons_list_wrapper.html" %}
  </div>

  {% if selected_livreur and selected_date %}
    <div class="col-md-6 col-lg-4 d-flex align-items-end mt-3">
      <a href="{% url 'fiche_livraison' %}?livreur={{ selected_livreur }}&date={{ selected_date }}" class="btn btn-success w-100" target="_blank">
        Voir fiche de livraison
      </a>
      <a href="{% url 'fiche_de_suivi' %}?livreur={{ selected_livreur }}&date={{ selected_date }}" class="btn btn-success w-100 ms-2" target="_blank">
        Voir fiche de suivi
      </a>
    </div>
  {% endif %}

  {% include "common/includes/pagination.html" with page_obj=page_obj extra_querystring=extra_querystring %}

</div>

{% for commande in commandes %}
  <div class="modal fade" id="editModal{{ commande.id }}" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'modifier_livraison' commande.id %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Modifier la livraison</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label>Livreur</label>
            <select name="livreur" class="form-select mb-2" required>
              {% for livreur in livreurs %}
                <option value="{{ livreur.id }}" {% if commande.livreur.id == livreur.id %}selected{% endif %}>{{ livreur.nom }}</option>
              {% endfor %}
            </select>

            <label>Frais livreur</label>
            <input type="number" name="frais_livreur" class="form-control" step="500" value="{{ commande.frais_livreur }}" required>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-success">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endfor %}

<style>
  .view-toggle .btn { padding: .375rem .6rem; }
  .view-toggle .btn.active { pointer-events: none; }
</style>

<script>
(function() {
  const toggle = document.querySelector('.view-toggle');
  const form = document.getElementById('livraisonsFiltersForm');
  const displayInput = document.getElementById('display_input');

  if (!toggle || !form || !displayInput) return;

  const getUrlPage = () => (new URLSearchParams(location.search)).get('page') || '';
  const getOrMakePageInput = () => {
    let el = document.getElementById('page_input');
    if (!el) {
      el = document.createElement('input');
      el.type = 'hidden'; el.name = 'page'; el.id = 'page_input';
      form.appendChild(el);
    }
    return el;
  };

  // Clic toggle: mémoriser & conserver la page courante
  toggle.addEventListener('click', function(e) {
    const btn = e.target.closest('button[data-mode]');
    if (!btn) return;
    const mode = btn.dataset.mode;

    toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const storageKey = toggle.dataset.storageKey || 'display_livraisons';
    localStorage.setItem(storageKey, mode);

    displayInput.value = mode;
    const pageInput = getOrMakePageInput();
    pageInput.value = getUrlPage();

    if (form.requestSubmit) form.requestSubmit(); else form.submit();
  });

  // Changement d’un filtre => retour page 1
  ['date','livreur','statut_livraison'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('change', () => {
      const pageInput = getOrMakePageInput();
      pageInput.value = '';
    });
  });

  // Après swap, resynchroniser page_input (utile après pagination)
  if (window.htmx) {
    htmx.on('htmx:afterSwap', function(evt) {
      if (evt.target && evt.target.id === 'livraisons-wrapper') {
        const pageInput = getOrMakePageInput();
        pageInput.value = getUrlPage();
      }
    });
  }
})();
</script>
{% endblock content %}