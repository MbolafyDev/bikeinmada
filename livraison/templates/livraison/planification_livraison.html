{% extends 'base.html' %}
{% load static %}
{% load nombre %}

{% block title %}Planification de livraison{% endblock %}

{% block content %}
<div class="container-fluid mb-2 mt-4">

  <h3 class="mb-4 text-center">Planification de livraison</h3>

  {% include "includes/messages_alert.html" %}

  <!-- Bouton FILTRES (mobile & tablettes) -->
  <div class="d-flex align-items-center mb-2">
    <button class="btn btn-outline-success ms-auto d-lg-none"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#filtersCollapse"
            aria-expanded="false"
            aria-controls="filtersCollapse">
      <i class="fa fa-filter me-1"></i> Filtres
    </button>
  </div>

  <!-- Formulaire de filtre (collapse en < lg, visible en ≥ lg) -->
  <div id="filtersCollapse" class="collapse d-lg-block">
    <form method="get" class="row g-3 mb-3" id="planningFiltersForm">
      <div class="col-md-3 col-sm-6">
        <label for="date" class="form-label fw-bold d-none d-lg-block">Date de livraison</label>
        <div class="input-group">
          <span class="input-group-text d-lg-none"><i class="fa fa-calendar"></i></span>
          <input type="date" name="date" id="date" class="form-control" value="{{ selected_date }}">
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <label for="livreur" class="form-label fw-bold d-none d-lg-block">Livreur</label>
        <div class="input-group">
          <span class="input-group-text d-lg-none"><i class="fa fa-user"></i></span>
          <select name="livreur" id="livreur" class="form-select">
            <option value="">Tous les livreurs</option>
            {% for livreur in livreurs %}
              <option value="{{ livreur.id }}" {% if livreur.id|stringformat:"s" == selected_livreur %}selected{% endif %}>
                {{ livreur.nom }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="col-md-4 col-sm-6">
        <label for="statut_livraison" class="form-label fw-bold d-none d-lg-block">Statut livraison</label>
        <div class="input-group">
          <span class="input-group-text d-lg-none"><i class="fa fa-bicycle"></i></span>
          <select name="statut_livraison" id="statut_livraison" class="form-select">
            <option value="">Tous les statuts</option>
            <option value="En attente"  {% if selected_statut == "En attente" %}selected{% endif %}>En attente</option>
            <option value="Planifiée"   {% if selected_statut == "Planifiée" %}selected{% endif %}>Planifiée</option>
            <option value="Livrée"      {% if selected_statut == "Livrée" %}selected{% endif %}>Livrée</option>
            <option value="Annulée"     {% if selected_statut == "Annulée" %}selected{% endif %}>Annulée</option>
          </select>
        </div>
      </div>

      <div class="col-md-2 col-sm-6 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-success w-100">
          <i class="fa fa-filter"></i> Filtrer
        </button>
      </div>
    </form>
  </div>

  {% if commandes %}
  <form method="post" action="{% url 'assigner_livreur_groupes' %}">
    {% csrf_token %}

    <!-- Table pour écrans larges -->
    <div class="table-responsive d-none d-lg-block">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-success">
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Date de livraison</th>
            <th>Client</th>
            <th>Lieu</th>
            <th class="text-end">Total</th>
            <th>Statut livraison</th>
            <th>Livreur</th>
            <th class="text-end">Frais livreur</th>
          </tr>
        </thead>
        <tbody>
          {% for commande in commandes %}
          <tr>
            <td><input type="checkbox" name="commandes" value="{{ commande.id }}"></td>
            <td>{{ commande.date_livraison|date:"d/m/Y" }}</td>
            <td>{{ commande.client.nom }}</td>
            <td>{{ commande.client.lieu.lieu }}</td>
            <td class="text-end">{{ commande.total_commande|intpoint }}</td>
            <td>{{ commande.statut_livraison }}</td>
            <td>{{ commande.livreur.nom }}</td>
            <td class="text-end">{{ commande.frais_livreur|intpoint }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Cartes pour écrans mobiles -->
    <div class="d-lg-none">
      <div class="row">
        {% for commande in commandes %}
        <div class="col-md-6 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" name="commandes" value="{{ commande.id }}">
                <label class="form-check-label text-success fw-bold">
                  Date prévue : {{ commande.date_livraison|date:"d/m/Y" }}
                </label>
              </div>
              <p class="mb-1"><strong>Client :</strong> {{ commande.client.nom }}</p>
              <p class="mb-1"><strong>Lieu :</strong> {{ commande.client.lieu.lieu }}</p>
              <p class="mb-1"><strong>Total :</strong> {{ commande.total_commande|intpoint }}</p>
              <p class="mb-1"><strong>Statut :</strong> {{ commande.statut_livraison }}</p>
              <p class="mb-1"><strong>Livreur :</strong> {{ commande.livreur.nom }}</p>
              <p class="mb-0"><strong>Frais :</strong> {{ commande.frais_livreur|intpoint }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4 col-sm-6 mb-2">
        <label for="livreur_id" class="form-label fw-bold">Livreur :</label>
        <select name="livreur_id" id="livreur_id" class="form-select" required>
          <option value="">-- Sélectionner un livreur --</option>
          {% for livreur in livreurs %}
            <option value="{{ livreur.id }}">{{ livreur.nom }} ({{ livreur.type }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 col-sm-6 mb-2">
        <label for="date_livraison" class="form-label fw-bold">Date de livraison :</label>
        <input type="date" name="date_livraison" id="date_livraison" class="form-control" required>
      </div>
      <div class="col-md-4 col-sm-12 d-flex align-items-end mb-2">
        <button type="submit" class="btn btn-success w-100">
          <i class="fa fa-bicycle"></i> Planifier la livraison
        </button>
      </div>
    </div>

  </form>
  {% else %}
  <div class="alert alert-info">Aucune commande en attente de livraison.</div>
  {% endif %}

  {% include "common/includes/pagination.html" with page_obj=page_obj extra_querystring=extra_querystring %}

</div>

<script>
  // Select all
  document.getElementById("selectAll")?.addEventListener("click", function(){
    var checkboxes = document.querySelectorAll("input[name='commandes']");
    for (var checkbox of checkboxes) {
      checkbox.checked = this.checked;
    }
  });

  // Fermer le panneau de filtres automatiquement sur mobile après submit
  (function(){
    const form = document.getElementById('planningFiltersForm');
    const collapseEl = document.getElementById('filtersCollapse');
    const isMobile = () => window.matchMedia('(max-width: 991.98px)').matches; // < lg
    if (!form || !collapseEl) return;

    form.addEventListener('submit', function(){
      if (!isMobile()) return;
      const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, {toggle: false});
      bsCollapse.hide();
    });
  })();
</script>
{% endblock %}
